<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://www.thanassis.space/coverage.html">
<meta name="author" content="Thanassis Tsiodras">
<meta name="author" content="Athanasios Tsiodras">
<meta name="author" content="ttsiod">
<meta name="author" content="ttsiodras">
<link type="text/css" rel="stylesheet" href="final-code-wavetheory-lightbox.css">
<link rel="stylesheet" type="text/css" href="asciinema-player.css">
<link type="application/rss+xml" rel="alternate" href="rss.xml" title="Coding and administration articles by ttsiodras">
<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript" src="scriptaculous.js?load=effects,builder"></script>
<script type="text/javascript" src="lightbox.js"></script>
<title>Cover me!</title>
</head>
<body>
    <div class="well" id="Page">
        <div id="Banner">Cover me!</div>
        <div id="MainContent">
            <a href="//www.reddit.com/r/programming/submit" onclick="window.location = window.location.protocol + '//www.reddit.com/r/programming/submit?url=' + encodeURIComponent(window.location); return false"> <img src="spreddit7.gif" alt="submit to programming reddit" border="0"> </a>
            <br>&nbsp;<br>
            <p><em>(April 2016)</em></p>

<h1>Cover me!</h1>

<div class="tldr">
<div style="color:red">
<b><em>Update, February 2022: <a href="https://raw.githubusercontent.com/nasa-jpl/embedded-gcov/main/Embedded_gcov_FSW-22_20220118.pdf">NASA/JPL adopted the embedded coverage technique I describe in this post!</a></em></b>
</div>

<p>I recently read an article about the lousy state of software quality... and it triggered
me to start writing what I hope will become a series on techniques and methods
to improve software quality, for both embedded and desktop machines: e.g.
using coverage, static analysis, code generation, powerful static type systems (Ada/Rust),
model-driven engineering, etc.
<p>
This first post is about coverage - and besides showcasing the basics,
moves on to deeper challenges that arise when you need to work with
embedded devices that have no filesystems - offering a solution that is
portable across all GCC versions, for all embedded platforms that are supported by GCC.
</div></p>

<h2>Software quality</h2>

<p>Today is a public holiday here in the Netherlands, so I spent a fair amount of 
my morning catching up on my favorite programming forums:
<a href="https://www.reddit.com/r/programming">Reddit/Programming</a>
and <a href="https://news.ycombinator.com">Hacker News</a>.</p>

<p>In both forums,
<a href="http://blog.dantup.com/2016/04/have-software-developers-given-up/" target="_blank">
<em>"Have software developers given up?"</em></a>
was on top of the list... Danny, the author of the piece, illustrates in
horrific-after-horrific screenshot the abysmal quality of software today... 
<br>&nbsp;<br>
<center><script type="text/javascript">
var element = document.createElement('video');
var hasWebM = element.canPlayType('video/webm');
var hasMP4 = element.canPlayType('video/mp4');
if (hasWebM || hasMP4) {
    var format = hasMP4?'mp4':'webm';
    var width = 320;
    var height = 240;
    document.write("<video " + 
                   "width='" + width + "' " +
                   "height='" + height + "'" +
                   "src='Data-Win95-crash." + format + "'" +
                   "type='video/" + format + "' autoplay='autoplay' loop='true'>&lt;" +
                   "/video>");
} else {
    // For the old generation, throw up a Flash control,
    // offering the same MP4 content.
    document.write(
        "<embed src='flvplayer.swf' width='320' height='240' " +
        "       bgcolor='#FFFFFF' type='application/x-shockwave-flash'" +
        "       pluginspage='http://www.macromedia.com/go/getflashplayer' " +
        "       flashvars='file=Data-Win95-crash.mp4&amp;autostart=true&amp;loop=true' />");
}
</script>
</center>
<p>What's even worse, is that this doesn't just apply to web applications (where
in principle at least, the software can be updated without the users involvement).
The market is now flooded with embedded devices, with software stacks that can
only be described as <em>barely</em> functional - never meant to be updated, left in
eternal limbo... The so-called "Internet of Things" is ushering in an era where
quality - and hence, security! - of the software running our everyday lives will
be subject to the whims of chance (<em>and hackers armed with exploits</em>).</p>

<h2>What if you care about quality?</h2>

<p>The market rewards "first to market" companies with orders of magnitude more money,
so naturally project and product managers prioritize towards delivery speed.</p>

<p>But there's also a technical component to this "quality equation", whose main points
I am hoping to address with a series of blog posts - this one being the first.</p>

<p>To begin with, there are many cases where "first to market" is NOT enough.</p>

<p>For example, code that will execute in a hospital, or a car, or a plane, or a
satellite - or any other safety-critical apparatus that demands a certain level
of quality. Usually this code is also meant to execute in an embedded environment;
that is, not in the usual desktop/server Intel machines, but in low-powered
micro-controllers or ARM platforms that control vital equipment.</p>

<p>How do you write that kind of code?</p>

<p>There are many opinions on the subject, and in this series we will attempt to
illustrate the most important ones.</p>

<p>But for now, let's start with something that everyone agrees on: <strong>Coverage</strong>.</p>

<h3>First step: Coverage on the host</h3>

<p>I am a firm believer in "hands-on" - so we will begin with a simple C example <a href="#pythontoo">[1]</a>,
that we will compile with GCC on our host (Intel) machine, and perform coverage
analysis on its execution. We will then move it to an embedded target and see
whether that is an issue ; and if so, how we can cope.</p>

<div class='codegenWrapper'>
<pre><tt><span class="comment">/* foo.c */</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdint.h&gt;</span>

<span class="usertype">uint16_t</span><span class="normal"> </span><span class="function">foo</span><span class="symbol">(</span><span class="usertype">uint16_t</span><span class="normal"> inputData</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">int</span><span class="normal"> value </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inputData </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        value </span><span class="symbol">=</span><span class="normal"> inputData </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">else</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        value </span><span class="symbol">=</span><span class="normal"> inputData </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inputData </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="cbracket">}</span>
</tt></pre>
</div>

<p>We now ask GCC to instrument it for coverage analysis <a href="#nooptimize">[2]</a>.
Notice how, in addition to the object file <code>foo.o</code>, a <code>foo.gcno</code> file is also generated:</p>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ gcc -c -g -O</span><span class="number">0</span><span class="normal"> -fprofile-arcs -ftest-coverage foo</span><span class="symbol">.</span><span class="normal">c</span>
<span class="normal">$ ls -l foo</span><span class="symbol">.*</span>
<span class="normal">-rw-r--r-- </span><span class="number">1</span><span class="normal"> ttsiod users  </span><span class="number">276</span><span class="normal"> Apr </span><span class="number">27</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span><span class="number">51</span><span class="normal"> foo</span><span class="symbol">.</span><span class="normal">c</span>
<span class="normal">-rw-r--r-- </span><span class="number">1</span><span class="normal"> ttsiod users </span><span class="number">3040</span><span class="normal"> Apr </span><span class="number">27</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span><span class="number">52</span><span class="normal"> foo</span><span class="symbol">.</span><span class="normal">o</span>
<span class="normal">-rw-r--r-- </span><span class="number">1</span><span class="normal"> ttsiod users  </span><span class="number">388</span><span class="normal"> Apr </span><span class="number">27</span><span class="normal"> </span><span class="number">16</span><span class="symbol">:</span><span class="number">52</span><span class="normal"> foo</span><span class="symbol">.</span><span class="normal">gcno</span>
</tt></pre>
</div>

<p>This file contains information that is used during coverage reporting - it's not so important at this point; focus your attention on the assembly code that GCC generated (boxed in ASCII-art below):</p>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ objdump -M intel -S foo</span><span class="symbol">.</span><span class="normal">o</span>

<span class="normal">Disassembly of section </span><span class="symbol">.</span><span class="normal">text</span><span class="symbol">:</span>

<span class="number">00000000</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal">foo</span><span class="symbol">&gt;:</span>
<span class="normal">    </span><span class="symbol">...</span>
<span class="normal">         </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inputData </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> {</span>

<span class="normal">   </span><span class="number">14</span><span class="symbol">:</span><span class="normal">   </span><span class="number">66</span><span class="normal"> </span><span class="number">83</span><span class="normal"> 7d ec </span><span class="number">09</span><span class="normal">     cmp    WORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x14</span><span class="symbol">],</span><span class="number">0x9</span>
<span class="normal">   </span><span class="number">19</span><span class="symbol">:</span><span class="normal">   </span><span class="number">77</span><span class="normal"> 0b              ja     </span><span class="number">26</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal">foo</span><span class="symbol">+</span><span class="number">0x26</span><span class="symbol">&gt;</span>

<span class="normal">             value </span><span class="symbol">=</span><span class="normal"> inputData </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>

<span class="normal">   1b</span><span class="symbol">:</span><span class="normal">   0f b7 </span><span class="number">45</span><span class="normal"> ec        movzx  eax</span><span class="symbol">,</span><span class="normal">WORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x14</span><span class="symbol">]</span><span class="normal">  </span><span class="symbol">;</span><span class="normal"> load input</span>
<span class="normal">   1f</span><span class="symbol">:</span><span class="normal">   </span><span class="number">01</span><span class="normal"> c0              add    eax</span><span class="symbol">,</span><span class="normal">eax                  </span><span class="symbol">;</span><span class="normal"> </span><span class="keyword">times</span><span class="normal"> </span><span class="number">2</span><span class="normal"> </span><span class="symbol">!</span>
<span class="normal">   </span><span class="number">21</span><span class="symbol">:</span><span class="normal">   </span><span class="number">89</span><span class="normal"> </span><span class="number">45</span><span class="normal"> </span><span class="keyword">fc</span><span class="normal">           mov    DWORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x4</span><span class="symbol">],</span><span class="normal">eax  </span><span class="symbol">;</span><span class="normal"> store result</span>
<span class="normal">   </span><span class="number">24</span><span class="symbol">:</span><span class="normal">   eb 2f              jmp    </span><span class="number">55</span><span class="normal"> </span><span class="symbol">&lt;</span><span class="normal">foo</span><span class="symbol">+</span><span class="number">0x55</span><span class="symbol">&gt;</span><span class="normal">            </span><span class="symbol">;</span><span class="normal"> and update ex</span><span class="symbol">.</span><span class="normal"> counter</span>

<span class="normal">         } </span><span class="keyword">else</span><span class="normal"> {</span>
<span class="normal">             value </span><span class="symbol">=</span><span class="normal"> inputData </span><span class="symbol">+</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inputData </span><span class="symbol">&gt;&gt;</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">   </span><span class="number">26</span><span class="symbol">:</span><span class="normal">   0f b7 </span><span class="number">55</span><span class="normal"> ec        movzx  edx</span><span class="symbol">,</span><span class="normal">WORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x14</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">;</span><span class="normal"> load input</span>
<span class="normal">   2a</span><span class="symbol">:</span><span class="normal">   0f b7 </span><span class="number">45</span><span class="normal"> ec        movzx  eax</span><span class="symbol">,</span><span class="normal">WORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x14</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">;</span><span class="normal"> copy it</span>
<span class="normal">   2e</span><span class="symbol">:</span><span class="normal">   </span><span class="number">66</span><span class="normal"> d1 e8           shr    ax</span><span class="symbol">,</span><span class="number">1</span><span class="normal">                    </span><span class="symbol">;</span><span class="normal"> </span><span class="keyword">shift</span><span class="normal"> it</span>
<span class="normal">   </span><span class="number">31</span><span class="symbol">:</span><span class="normal">   0f b7 c0           movzx  eax</span><span class="symbol">,</span><span class="normal">ax</span>
<span class="normal">   </span><span class="number">34</span><span class="symbol">:</span><span class="normal">   </span><span class="number">01</span><span class="normal"> d0              add    eax</span><span class="symbol">,</span><span class="normal">edx                 </span><span class="symbol">;</span><span class="normal"> add it</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">done</span><span class="symbol">!</span>
<span class="normal">   </span><span class="number">36</span><span class="symbol">:</span><span class="normal">   </span><span class="number">89</span><span class="normal"> </span><span class="number">45</span><span class="normal"> </span><span class="keyword">fc</span><span class="normal">           mov    DWORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x4</span><span class="symbol">],</span><span class="normal">eax </span><span class="symbol">;</span><span class="normal"> store result</span>
<span class="normal">                                                           </span><span class="symbol">;</span><span class="normal"> and update ex</span><span class="symbol">.</span><span class="normal"> counter</span>
<span class="symbol">.</span><span class="normal">-------------------------- COVERAGE CODE KEEPING TRACK ---------------------------</span><span class="symbol">.</span>
<span class="symbol">|</span><span class="normal">                                                                                  </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">39</span><span class="symbol">:</span><span class="normal">   a1 </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">     mov    eax</span><span class="symbol">,</span><span class="normal">ds</span><span class="symbol">:</span><span class="number">0x0</span><span class="normal">                                      </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  3e</span><span class="symbol">:</span><span class="normal">   8b </span><span class="number">15</span><span class="normal"> </span><span class="number">04</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">  mov    edx</span><span class="symbol">,</span><span class="normal">DWORD PTR ds</span><span class="symbol">:</span><span class="number">0x4</span><span class="normal">  </span><span class="symbol">;</span><span class="normal"> increase 64bit edx</span><span class="symbol">:</span><span class="normal">eax  </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">44</span><span class="symbol">:</span><span class="normal">   </span><span class="number">83</span><span class="normal"> c0 </span><span class="number">01</span><span class="normal">           add    eax</span><span class="symbol">,</span><span class="number">0x1</span><span class="normal">               </span><span class="symbol">;</span><span class="normal"> coverage counter by </span><span class="number">1</span><span class="normal">   </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">47</span><span class="symbol">:</span><span class="normal">   </span><span class="number">83</span><span class="normal"> d2 </span><span class="number">00</span><span class="normal">           adc    edx</span><span class="symbol">,</span><span class="number">0x0</span><span class="normal">               </span><span class="symbol">;</span><span class="normal"> carry over to edx       </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  4a</span><span class="symbol">:</span><span class="normal">   a3 </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">     mov    ds</span><span class="symbol">:</span><span class="number">0x0</span><span class="symbol">,</span><span class="normal">eax            </span><span class="symbol">;</span><span class="normal"> store </span><span class="number">64</span><span class="normal"> bits to ds</span><span class="symbol">:</span><span class="number">0</span><span class="normal">   </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  4f</span><span class="symbol">:</span><span class="normal">   </span><span class="number">89</span><span class="normal"> </span><span class="number">15</span><span class="normal"> </span><span class="number">04</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">  mov    DWORD PTR ds</span><span class="symbol">:</span><span class="number">0x4</span><span class="symbol">,</span><span class="normal">edx  </span><span class="symbol">;</span><span class="normal"> and ds</span><span class="symbol">:</span><span class="number">4</span><span class="normal">                </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">                                                                                  </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">        }                                                                         </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">        </span><span class="keyword">return</span><span class="normal"> value</span><span class="symbol">;</span><span class="normal">                                                             </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">                                                                                  </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">55</span><span class="symbol">:</span><span class="normal">   8b </span><span class="number">45</span><span class="normal"> </span><span class="keyword">fc</span><span class="normal">           mov    eax</span><span class="symbol">,</span><span class="normal">DWORD PTR </span><span class="symbol">[</span><span class="normal">ebp-</span><span class="number">0x4</span><span class="symbol">]</span><span class="normal">                         </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">58</span><span class="symbol">:</span><span class="normal">   </span><span class="number">89</span><span class="normal"> c1              mov    ecx</span><span class="symbol">,</span><span class="normal">eax                                         </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  5a</span><span class="symbol">:</span><span class="normal">   a1 </span><span class="number">08</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">     mov    eax</span><span class="symbol">,</span><span class="normal">ds</span><span class="symbol">:</span><span class="number">0x8</span><span class="normal">                                      </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  5f</span><span class="symbol">:</span><span class="normal">   8b </span><span class="number">15</span><span class="normal"> 0c </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">  mov    edx</span><span class="symbol">,</span><span class="normal">DWORD PTR ds</span><span class="symbol">:</span><span class="number">0xc</span><span class="normal">  </span><span class="symbol">;</span><span class="normal"> increase 64bit edx</span><span class="symbol">:</span><span class="normal">eax  </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">65</span><span class="symbol">:</span><span class="normal">   </span><span class="number">83</span><span class="normal"> c0 </span><span class="number">01</span><span class="normal">           add    eax</span><span class="symbol">,</span><span class="number">0x1</span><span class="normal">               </span><span class="symbol">;</span><span class="normal"> coverage counter by </span><span class="number">1</span><span class="normal">   </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">68</span><span class="symbol">:</span><span class="normal">   </span><span class="number">83</span><span class="normal"> d2 </span><span class="number">00</span><span class="normal">           adc    edx</span><span class="symbol">,</span><span class="number">0x0</span><span class="normal">               </span><span class="symbol">;</span><span class="normal"> carry over to edx       </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  6b</span><span class="symbol">:</span><span class="normal">   a3 </span><span class="number">08</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">     mov    ds</span><span class="symbol">:</span><span class="number">0x8</span><span class="symbol">,</span><span class="normal">eax            </span><span class="symbol">;</span><span class="normal"> store 64bits to ds</span><span class="symbol">:</span><span class="number">8</span><span class="normal">    </span><span class="symbol">|</span>
<span class="symbol">|</span><span class="normal">  </span><span class="number">70</span><span class="symbol">:</span><span class="normal">   </span><span class="number">89</span><span class="normal"> </span><span class="number">15</span><span class="normal"> 0c </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal"> </span><span class="number">00</span><span class="normal">  mov    DWORD PTR ds</span><span class="symbol">:</span><span class="number">0xc</span><span class="symbol">,</span><span class="normal">edx  </span><span class="symbol">;</span><span class="normal"> and ds</span><span class="symbol">:</span><span class="number">0xc</span><span class="normal">              </span><span class="symbol">|</span>
<span class="symbol">\</span><span class="normal">__________________________________________________________________________________</span><span class="symbol">/</span>
</tt></pre>
</div>

<p>Basically, depending on which branch of the <code>if</code> we end up executing, the code will keep track
of the number of executions in different 64bit counters (managed via the 64bit <code>edx:eax</code> pair
of registers). These counters are stored in <code>ds:0</code> and <code>ds:8</code> for our two branches.</p>

<h3>Annotating the source via the execution counters</h3>

<p>Running a small test, we can then annotate the code from the execution counters
logs - that are somehow <em>(magically? keep reading)</em> saved in <code>.gcda</code> files:</p>

<div class='codegenWrapper'>
<pre><tt><span class="comment">/* tst.c */</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;stdint.h&gt;</span>

<span class="keyword">extern</span><span class="normal"> </span><span class="usertype">uint16_t</span><span class="normal"> </span><span class="function">foo</span><span class="symbol">(</span><span class="usertype">uint16_t</span><span class="normal"> inputData</span><span class="symbol">);</span>

<span class="type">int</span><span class="normal"> </span><span class="function">main</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">foo</span><span class="symbol">(</span><span class="number">5</span><span class="symbol">);</span>
<span class="normal">    </span><span class="keyword">return</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="cbracket">}</span>
</tt></pre>
</div>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ </span><span class="comment"># Compile testing code</span>
<span class="normal">$ gcc -c -g -O</span><span class="number">0</span><span class="normal"> -fprofile-arcs -ftest-coverage -Wall tst</span><span class="symbol">.</span><span class="normal">c</span>

<span class="normal">$ </span><span class="comment"># Link testing code with our library function</span>
<span class="normal">$ gcc -g -O</span><span class="number">0</span><span class="normal"> -fprofile-arcs -ftest-coverage -o coverme tst</span><span class="symbol">.</span><span class="normal">o foo</span><span class="symbol">.</span><span class="normal">o</span>

<span class="normal">$ </span><span class="comment"># Run Forrest, run!</span>
<span class="normal">$ </span><span class="symbol">.</span><span class="normal">/coverme</span>

<span class="normal">$ </span><span class="comment"># The .gcda files contain the execution counters we saw above</span>
<span class="normal">$ ls -l </span><span class="symbol">*.</span><span class="normal">gcda</span>
<span class="normal">-rw-r--r-- </span><span class="number">1</span><span class="normal"> ttsiod users </span><span class="number">176</span><span class="normal"> Apr </span><span class="number">27</span><span class="normal"> </span><span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="normal"> foo</span><span class="symbol">.</span><span class="normal">gcda</span>
<span class="normal">-rw-r--r-- </span><span class="number">1</span><span class="normal"> ttsiod users </span><span class="number">176</span><span class="normal"> Apr </span><span class="number">27</span><span class="normal"> </span><span class="number">18</span><span class="symbol">:</span><span class="number">12</span><span class="normal"> tst</span><span class="symbol">.</span><span class="normal">gcda</span>
</tt></pre>
</div>

<p>Finally, <code>gcov</code> can now annotate our code, and using both the <code>.gcno</code>
<em>(compile-time generated)</em> and <code>.gcda</code> <em>(run-time generated)</em> files,
report back that our tests only passed through one side of
our <code>if</code>: <em>(notice the ##### below)</em></p>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ gcov -b foo</span><span class="symbol">.</span><span class="normal">c</span>
<span class="normal">File </span><span class="string">'foo.c'</span>
<span class="normal">Lines executed</span><span class="symbol">:</span><span class="number">83.33</span><span class="symbol">%</span><span class="normal"> of </span><span class="number">6</span>
<span class="normal">Branches executed</span><span class="symbol">:</span><span class="number">100.00</span><span class="symbol">%</span><span class="normal"> of </span><span class="number">2</span>
<span class="normal">Taken at least once</span><span class="symbol">:</span><span class="number">50.00</span><span class="symbol">%</span><span class="normal"> of </span><span class="number">2</span>
<span class="normal">No calls</span>
<span class="normal">Creating </span><span class="string">'foo.c.gcov'</span>

<span class="normal">$ cat foo</span><span class="symbol">.</span><span class="normal">c</span><span class="symbol">.</span><span class="normal">gcov</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">0</span><span class="symbol">:</span><span class="normal">Source</span><span class="symbol">:</span><span class="normal">foo</span><span class="symbol">.</span><span class="normal">c</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">0</span><span class="symbol">:</span><span class="normal">Graph</span><span class="symbol">:</span><span class="normal">foo</span><span class="symbol">.</span><span class="normal">gcno</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">0</span><span class="symbol">:</span><span class="normal">Data</span><span class="symbol">:</span><span class="normal">foo</span><span class="symbol">.</span><span class="normal">gcda</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">0</span><span class="symbol">:</span><span class="normal">Runs</span><span class="symbol">:</span><span class="number">1</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">0</span><span class="symbol">:</span><span class="normal">Programs</span><span class="symbol">:</span><span class="number">1</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">1</span><span class="symbol">:</span><span class="comment">#include &lt;stdint.h&gt;</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">2</span><span class="symbol">:</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">3</span><span class="symbol">:/*</span><span class="normal"> foo</span><span class="symbol">.</span><span class="normal">c </span><span class="symbol">*/</span>
<span class="function">function foo </span><span class="normal">called </span><span class="number">1</span><span class="normal"> returned </span><span class="number">100</span><span class="symbol">%</span><span class="normal"> blocks executed </span><span class="number">80</span><span class="symbol">%</span>
<span class="normal">        </span><span class="number">1</span><span class="symbol">:</span><span class="normal">    </span><span class="number">4</span><span class="symbol">:</span><span class="normal">uint16_t foo</span><span class="symbol">(</span><span class="normal">uint16_t inputData</span><span class="symbol">)</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">5</span><span class="symbol">:</span><span class="normal">{</span>
<span class="normal">        </span><span class="number">1</span><span class="symbol">:</span><span class="normal">    </span><span class="number">6</span><span class="symbol">:</span><span class="normal">    int value </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">        </span><span class="number">1</span><span class="symbol">:</span><span class="normal">    </span><span class="number">7</span><span class="symbol">:</span><span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">inputData </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">10</span><span class="symbol">)</span><span class="normal"> {</span>
<span class="normal">branch  </span><span class="number">0</span><span class="normal"> taken </span><span class="number">100</span><span class="symbol">%</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">fallthrough</span><span class="symbol">)</span>
<span class="normal">branch  </span><span class="number">1</span><span class="normal"> taken </span><span class="number">0</span><span class="symbol">%</span>
<span class="normal">        </span><span class="number">1</span><span class="symbol">:</span><span class="normal">    </span><span class="number">8</span><span class="symbol">:</span><span class="normal">        value </span><span class="symbol">=</span><span class="normal"> inputData </span><span class="symbol">*</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">    </span><span class="number">9</span><span class="symbol">:</span><span class="normal">    } </span><span class="keyword">else</span><span class="normal"> {</span>
<span class="normal">    </span><span class="comment">#####:   10:        value = inputData + inputData &gt;&gt; 1;</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">   </span><span class="number">11</span><span class="symbol">:</span><span class="normal">    }</span>
<span class="normal">        </span><span class="number">1</span><span class="symbol">:</span><span class="normal">   </span><span class="number">12</span><span class="symbol">:</span><span class="normal">    </span><span class="keyword">return</span><span class="normal"> value</span><span class="symbol">;</span>
<span class="normal">        -</span><span class="symbol">:</span><span class="normal">   </span><span class="number">13</span><span class="symbol">:</span><span class="normal">}</span>
</tt></pre>
</div>

<p>That's how you know that your tests are incomplete - you need to write
some more tests to exercise the missing branch (the one that was
<code>taken 0%</code> of the time).</p>

<p>You must now automate this kind of check - e.g. have your continuous integration
automatically <code>grep</code> your coverage reports to make sure there are no 'taken 0%'
in the output, and no '#####' either).</p>

<p>This will give you 100% statement and branch coverage.</p>

<h3>Navigating the annotated files</h3>

<p>You can also use <code>lcov</code> - to create much better looking, hyperlinked
and nicely colored outputs:</p>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ lcov --rc </span><span class="variable">lcov_branch_coverage</span><span class="symbol">=</span><span class="number">1</span><span class="normal"> --capture --directory </span><span class="symbol">.</span><span class="normal"> </span><span class="symbol">\</span>
<span class="normal">    --output-file coverage</span><span class="symbol">.</span><span class="normal">info</span>
<span class="normal">$ genhtml --branch-coverage coverage</span><span class="symbol">.</span><span class="normal">info --output-directory coverage</span>
</tt></pre>
</div>

<p><br>&nbsp;<br>
<center>
<img src="coverage1.png" alt="Top-level report in LCOV">
<br>
<em>Top-level report in LCOV</em>
<br>&nbsp;<br>
<img src="coverage2.png" alt="Looking at foo.c report in LCOV">
<br>
<em>Looking at foo.c report in LCOV</em>
</center>
<br>&nbsp;<br>
<p>Seeing the parts of your code that have never been exercised is
very easy with LCOV.</p>

<h2>Embedded platforms and coverage</h2>

<p>You may be wondering about how these <code>.gcda</code> files are generated.
If you work with non-embedded platforms, the best answer is probably
"<em>by magic</em>" ; this answer covers your needs, so go ahead with it -
<a href="http://threevirtues.com/">laziness is a virtue</a>. Write your tests, reach
100% statement and branch coverage, feel proud. Smile.</p>

<p>But what about <a href="https://en.wikipedia.org/wiki/St_Crispin%27s_Day_Speech">those few, those happy few</a>,
that target embedded platforms?</p>

<p>Well, you will probably need to understand a bit more about the
mechanics behind <code>.gcda</code> files.</p>

<p>In embedded spaces, there's probably <strong>NO</strong> filesystem to speak of.
And whatever <em>magic</em> your platform's GCC is using to generate the <code>.gcda</code> information at the end of execution
(<code>.fini</code> sections, or <code>__attribute__((destructor))</code> function pointers, etc),
the coverage counters won't be saved anywhere if there's no filesystem to speak of.</p>

<p>Somehow, the information that is used to <em>create</em> the <code>.gcda</code> files 
must be communicated back to your host machine...  Since that's where
your source files are - that's where the coverage annotation must take place.</p>

<p>And it's at this point that things may become much more difficult...</p>

<ul>
<li>Your embedded platform has its own communication interfaces. Whether
it's a good old serial interface, or a serial-over-USB, or a JTAG connection,
or whatever - you need to transfer the coverage data over it, back to the host.</li>
<li>The coverage data are GCC-version-specific - and GCC documentation
specifically states that they don't care about portability of this
"counter" data ; each GCC version has its own <code>gcov-io.h/.c</code> that dictates
how the information is structured in memory.</li>
</ul>

<p><center>
<img src="pain.jpg" alt="Oh God, this will hurt">
</center>
<p>So how do you get this GCC-version-specific and platform-specific
information back to your host machine over your embedded-system-specific
communication channels, and then annotate your source files with
execution coverage information?</p>

<h2>GDB scripting to the rescue</h2>

<p>If only there was an application-agnostic and platform-agnostic way to
communicate with your embedded device at runtime... and then at the
right point in the execution, stop the application and read (<em>the coverage</em>)
information OUT of it!</p>

<p>Oh wait. Isn't that what a debugger is for?</p>

<p>Yes! Not only can you use your faithful platform-specific GDB to remote
debug (i.e. connect to the embedded target via it's <code>tar extended-remote...</code>
command), but you can also script it, so that at the <em>right moment</em>
(i.e. at the right breakpoint!) you can extract the information you need
back to the host, and <code>dump</code> it in host-local files.</p>

<p>The question is... what information should we get back to the host to
create our <code>.gcda</code> files?</p>

<h2>GCDA files and the Linux kernel</h2>

<p>Ideally, we'd want to transfer the <em>actual</em> content that would have been
saved in the <code>.gcda</code> files (if we did have a filesystem) back to the host.</p>

<p>And it turns out... that we find exactly that in the sources of the Linux
kernel. The executive summary is that the kernel devs faced the same coverage problem.
To address it, they coded <a href="https://elixir.bootlin.com/linux/latest/source/kernel/gcov">a few files</a>
that provide a GCC-version-agnostic function doing <em>exactly</em> what we wanted:</p>

<div class='codegenWrapper'>
<pre><tt><span class="usertype">size_t</span><span class="normal"> </span><span class="function">convert_to_gcda</span><span class="symbol">(</span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">gcov_info</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">);</span>
</tt></pre>
</div>

<p>This function will generate the content of a <code>.gcda</code> file and store it
in the memory pointed to by <code>buffer</code>. It also follows a well-used pattern
in the Linux kernel, where if you call it first with <code>buffer</code> set to NULL, it returns
how many bytes you'll need to <code>malloc</code> to store the information.</p>

<p>The way this function works across all GCC versions, is that the types
it uses only contain the "parts that never changed" in the relevant
GCC structures. Think of it as knowing that e.g. the 3rd 32 bit value stored
in the main <code>info</code> coverage structure is a pointer to the <code>.gcda</code> filename.</p>

<p>So the only missing piece of the puzzle is that <code>info</code> variable - where do we
get hold of it?</p>

<p>Simple: When you compile your
application with the coverage options (i.e. <code>-ftest-coverage -fprofile-arcs</code>),
GCC's runtime, upon startup, calls a <code>__gcov_init</code> - for <em>as many times as there are
.gcda files to be made</em> - and in each call, the GCC runtime passes it
a <code>struct gcov_info *</code>.</p>

<p>All you have to do is provide your own <code>__gcov_init</code> that will store these
<code>struct gcov_info</code> pointers (at program startup), and then at the end,
your code will have to iterate over each one of them - calling
<code>convert_to_gcda</code> to generate the <code>.gcda</code> file information in memory.</p>

<p>Here's <a href="
https://gitrepos.estec.esa.int/ttsiodras/RTEMS-build-workflows/blob/coverage/OAR/src/base.c">a link to a complete example</a>
that I am using for the embedded platforms I work with in the European Space
Agency - i.e. our Leon2 and Leon3 targets. The key parts are shown below:</p>

<div class='codegenWrapper'>
<pre><tt><span class="keyword">typedef</span><span class="normal"> </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">tagGcovInfo</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">gcov_info</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">tagGcovInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">next</span><span class="symbol">;</span>
<span class="cbracket">}</span><span class="normal"> GcovInfo</span><span class="symbol">;</span>
<span class="usertype">GcovInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">headGcov </span><span class="symbol">=</span><span class="normal"> NULL</span><span class="symbol">;</span>

<span class="comment">/*</span>
<span class="comment"> * __gcov_init is called by gcc-generated constructor code for each object</span>
<span class="comment"> * file compiled with -fprofile-arcs.</span>
<span class="comment"> */</span>
<span class="type">void</span><span class="normal"> </span><span class="function">__gcov_init</span><span class="symbol">(</span><span class="keyword">struct</span><span class="normal"> </span><span class="classname">gcov_info</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">info</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="function">printf</span><span class="symbol">(</span>
<span class="normal">        </span><span class="string">"__gcov_init called for %s!</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">        </span><span class="function">gcov_info_filename</span><span class="symbol">(</span><span class="normal">info</span><span class="symbol">));</span>
<span class="normal">    </span><span class="function">fflush</span><span class="symbol">(</span><span class="normal">stdout</span><span class="symbol">);</span>
<span class="normal">    </span><span class="usertype">GcovInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">newHead </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="keyword">sizeof</span><span class="symbol">(</span><span class="normal">GcovInfo</span><span class="symbol">));</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">newHead</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="function">puts</span><span class="symbol">(</span><span class="string">"Out of memory!"</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">exit</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    newHead</span><span class="symbol">-&gt;</span><span class="normal">info </span><span class="symbol">=</span><span class="normal"> info</span><span class="symbol">;</span>
<span class="normal">    newHead</span><span class="symbol">-&gt;</span><span class="normal">next </span><span class="symbol">=</span><span class="normal"> headGcov</span><span class="symbol">;</span>
<span class="normal">    headGcov </span><span class="symbol">=</span><span class="normal"> newHead</span><span class="symbol">;</span>
<span class="cbracket">}</span>

<span class="type">void</span><span class="normal"> </span><span class="function">__gcov_exit</span><span class="symbol">()</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="usertype">GcovInfo</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">tmp </span><span class="symbol">=</span><span class="normal"> headGcov</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">while</span><span class="symbol">(</span><span class="normal">tmp</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="type">char</span><span class="normal"> </span><span class="symbol">*</span><span class="normal">buffer</span><span class="symbol">;</span>
<span class="normal">        </span><span class="type">unsigned</span><span class="normal"> bytesNeeded </span><span class="symbol">=</span><span class="normal"> </span><span class="function">convert_to_gcda</span><span class="symbol">(</span><span class="normal">NULL</span><span class="symbol">,</span><span class="normal"> tmp</span><span class="symbol">-&gt;</span><span class="normal">info</span><span class="symbol">);</span>
<span class="normal">        buffer </span><span class="symbol">=</span><span class="normal"> </span><span class="function">malloc</span><span class="symbol">(</span><span class="normal">bytesNeeded</span><span class="symbol">);</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(!</span><span class="normal">buffer</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="function">puts</span><span class="symbol">(</span><span class="string">"Out of memory!"</span><span class="symbol">);</span>
<span class="normal">            </span><span class="function">exit</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">);</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="function">convert_to_gcda</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">,</span><span class="normal"> tmp</span><span class="symbol">-&gt;</span><span class="normal">info</span><span class="symbol">);</span>
<span class="normal">        </span><span class="function">printf</span><span class="symbol">(</span><span class="string">"Emitting %6d bytes for %s</span><span class="specialchar">\n</span><span class="string">"</span><span class="symbol">,</span><span class="normal"> bytesNeeded</span><span class="symbol">,</span><span class="normal"> </span><span class="function">gcov_info_filename</span><span class="symbol">(</span><span class="normal">tmp</span><span class="symbol">-&gt;</span><span class="normal">info</span><span class="symbol">));</span>
<span class="normal">        </span><span class="function">free</span><span class="symbol">(</span><span class="normal">buffer</span><span class="symbol">);</span>
<span class="normal">        tmp </span><span class="symbol">=</span><span class="normal"> tmp</span><span class="symbol">-&gt;</span><span class="normal">next</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>
</tt></pre>
</div>

<p>The code in our custom <code>__gcov_init</code> (which is called automatically by GCC's runtime at
application startup) stores the received pointers in a simple linked
list. <code>__gcov_exit</code> then invokes the Linux-provided <code>convert_to_gcda</code>
to generate the coverage information.</p>

<p>To sum it up, we can use a very tiny part of Linux kernel code that
creates the <code>.gcda</code> file information in memory, on the embedded target;
without caring about platform or GCC-version specifics. Being Linux
kernel code it requires a bit of a 'cleanup' - e.g. change <code>vmalloc</code>,
<code>kfree</code> and <code>kdup</code> to C RTL functions (<code>malloc</code>, <code>free</code>, <code>dup</code>) - but that's
a small price to pay to get our <code>.gcda</code> content.</p>

<h2>But we need that information back in the host, no?</h2>

<p>Yes, indeed we do - and that's where GDB scripting comes in:</p>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ cat automate_coverage</span><span class="symbol">.</span><span class="normal">gdb</span>

<span class="normal">tar extended-remote </span><span class="symbol">....</span><span class="normal">  </span><span class="comment"># connect to the board</span>
<span class="normal">load binary</span>

<span class="normal">b base</span><span class="symbol">.</span><span class="normal">c</span><span class="symbol">:</span><span class="number">79</span><span class="normal">  </span><span class="comment"># This breaks on the 'Emitting' printf above in __gcov_exit</span>
<span class="normal">commands </span><span class="number">1</span>
<span class="normal">    </span><span class="comment"># saving the coverage info back to the host in proper .gcda file</span>
<span class="normal">    silent</span>
<span class="normal">    </span><span class="keyword">set</span><span class="normal"> </span><span class="variable">$filename</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> tmp-</span><span class="symbol">&gt;</span><span class="normal">info-</span><span class="symbol">&gt;</span><span class="normal">filename</span>
<span class="normal">    </span><span class="keyword">set</span><span class="normal"> </span><span class="variable">$dataBegin</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> buffer</span>
<span class="normal">    </span><span class="keyword">set</span><span class="normal"> </span><span class="variable">$dataEnd</span><span class="normal"> </span><span class="symbol">=</span><span class="normal"> buffer </span><span class="symbol">+</span><span class="normal"> bytesNeeded</span>
<span class="normal">    </span><span class="keyword">eval</span><span class="normal"> </span><span class="string">"dump binary memory %s 0x%lx 0x%lx"</span><span class="symbol">,</span><span class="normal"> </span><span class="variable">$filename</span><span class="symbol">,</span><span class="normal"> </span><span class="variable">$dataBegin</span><span class="symbol">,</span><span class="normal"> </span><span class="variable">$dataEnd</span>
<span class="normal">    echo dump binary memory </span><span class="variable">$filename</span><span class="normal"> </span><span class="variable">$dataBegin</span><span class="normal"> </span><span class="variable">$dataEnd</span>
<span class="normal">    echo </span><span class="symbol">\</span><span class="normal">n</span>
<span class="normal">    c</span>
<span class="normal">end</span>
<span class="normal">c</span>

<span class="normal">$ MYPLATFORM-gdb -x automate_coverage</span><span class="symbol">.</span><span class="normal">gdb</span>
</tt></pre>
</div>

<p>After connecting to our embedded target, and loading our binary, we set
a breakpoint right after calling <code>convert_to_gcda</code> - and invoke <code>dump</code>
to save the <code>.gcda</code> information in the properly named .gcda file
(the filename is accessible via the pointers given to us during <code>__gcov_init</code>).</p>

<p>That's it.</p>

<p>All the pieces are now in place, for on-target coverage analysis.</p>

<h2>Can this be made faster?</h2>

<p>In some platforms, the GDB connection may be slow (e.g. executing over serial
connections).</p>

<p>But if your platform is supported by QEMU, you can then use the <em>same</em> approach just
described to run your binaries under a simulated version of your platform - which
will of course run a lot
faster.</p>

<p>As an example, here's a piece of the Makefile target I am using for my work
with Leon3 boards at ESA: <a href="https://gitrepos.estec.esa.int/ttsiodras/RTEMS-build-workflows/blob/coverage/OAR/Makefile#L170">my <code>make coverage</code> rule</a>:</p>

<div class='codegenWrapper'>
<pre><tt><span class="normal">coverage-common</span><span class="symbol">:</span>
<span class="normal">   </span><span class="variable">$(MAKE)</span><span class="normal"> clean</span>
<span class="normal">   </span><span class="variable">$(MAKE)</span><span class="normal"> </span><span class="variable">CFG</span><span class="symbol">=</span><span class="normal">debug </span><span class="variable">LEON</span><span class="symbol">=</span><span class="normal">leon3 </span><span class="variable">COVERAGE</span><span class="symbol">=</span><span class="number">1</span><span class="normal"> </span><span class="variable">FPU</span><span class="symbol">=</span><span class="number">1</span>
<span class="normal">   </span><span class="comment"># Spawning QEMU with our coverage enabled binary</span>
<span class="normal">   qemu-system-sparc -nographic -M leon3_generic -m 64M -kernel  </span><span class="symbol">\</span>
<span class="normal">       bin</span><span class="symbol">.</span><span class="normal">debug</span><span class="symbol">.</span><span class="normal">FPU</span><span class="symbol">.</span><span class="normal">leon3</span><span class="symbol">.</span><span class="normal">WITH_COVERAGE/fputest -gdb tcp</span><span class="symbol">::</span><span class="number">9976</span><span class="normal"> -S </span><span class="symbol">&amp;</span>
<span class="normal">   </span><span class="comment"># Spawning GDB and running the coverage script</span>
<span class="normal">   sleep </span><span class="number">2</span><span class="normal"> </span><span class="symbol">;</span><span class="normal"> sparc-rtems</span><span class="number">4.11</span><span class="normal">-gdb -x contrib/coverage</span><span class="symbol">.</span><span class="normal">gdb </span><span class="symbol">&lt;</span><span class="normal">/dev/null</span>

<span class="normal">coverage</span><span class="symbol">:</span><span class="normal">  coverage-common</span>
<span class="normal">   </span><span class="comment"># Reporting the results</span>
<span class="normal">   mkdir -p coverage </span><span class="symbol">;</span><span class="normal">                                             </span><span class="symbol">\</span>
<span class="normal">   cd coverage </span><span class="symbol">;</span><span class="normal">                                                   </span><span class="symbol">\</span>
<span class="normal">   ln -s </span><span class="symbol">..</span><span class="normal">/src </span><span class="symbol">;</span><span class="normal">                                                  </span><span class="symbol">\</span>
<span class="normal">   sparc-rtems</span><span class="number">4.11</span><span class="normal">-gcov </span><span class="symbol">..</span><span class="normal">/objs</span><span class="symbol">.</span><span class="normal">debug</span><span class="symbol">.</span><span class="normal">FPU</span><span class="symbol">.</span><span class="normal">leon3</span><span class="symbol">.</span><span class="normal">WITH_COV</span><span class="symbol">*/*</span><span class="normal">gcda</span>
<span class="normal">   @echo</span>
<span class="normal">   @echo </span><span class="symbol">==================================================</span>
<span class="normal">   @echo The coverage-annotated sources are under coverage</span><span class="symbol">/</span>
<span class="normal">   @echo </span><span class="symbol">==================================================</span>
</tt></pre>
</div>

<p>As you can see, I spawn a custom-compiled QEMU that simulates my target
platform (the Leon3 used in many ESA missions) and then start it in GDB
server mode (<code>-gdb tcp::9976</code>). I can then connect to it over port 9976 from
my GDB's <code>tar extended-remote ...</code> (see GDB script in previous section) -
that is, just as I do with the real boards. And then run my tests
completely automatically, on the host alone - no need for a board.</p>

<p>In plain words - continuous integration becomes as simple as doing <code>make coverage</code>
from your Hudson/Jenkins/WhateverCI server.</p>

<h2>No need for real boards then?</h2>

<p>That would be too much :-)</p>

<p>You must always test on the embedded target as well -
after all, QEMU may fail to emulate properly some important piece of
your board.</p>

<p>The good thing with the approach as I described it in the sections above, is
that it works on both simulated and real targets at no extra cost. You can
setup your continuous integration to execute the tests upon commit under QEMU,
but also on a real board every week/month/etc - whatever your hardware's
speed allows.</p>

<p>Just make sure to always check with a real board - especially before
the final reviews :-)</p>

<h1>Summary</h1>

<p>It was a long post - if you made it this far, congratulations! I believe
that you now know a lot more about coverage than most IoT makers out
there <em>(just kidding - I think ;-)</em></p>

<p>I am pretty sure that most of the code out there today isn't
even <em>close</em> to 100% statement coverage (that is, even if we ignore branch coverage).</p>

<p>Maybe this post will inspire some of you to start moving towards that goal.</p>

<p>And of course there's a whole world after coverage ; including static
analysis, and model-driven code generation, and much better type
systems than those of poor C (that is: Ada, Rust, etc).</p>

<p>But we'll tackle these in future posts :-)</p>

<h2>Notes</h2>

<ol>
<li><p><a name="pythontoo"></a> The same forms you see here applied for C,
exist in pretty much all languages. Study the coverage support in the
language you use, and you'll see the same pattern ; basically execution
traces are logged and then used to annotate the code.</p></li>
<li><p><a name="nooptimize"></a> We invoke GCC with <code>-O0</code> to disable optimizations;
you really don't want to do coverage analysis with optimizations enabled,
since the results may very well be messed up - think about inlining and
you'll understand.</p></li>
</ol>

<br>
    <hr>
    <div style='margin-top:1em'>
        <div style='float:left'>
            <a target="_blank" href="https://stackoverflow.com/users/382050/ttsiodras">
                <img src="382050.png" width="208" height="58" alt="profile for ttsiodras at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for ttsiodras at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
            </a>
        </div>
        <div style='float:left; margin-left:1em'>
            <a target="_blank" href="https://github.com/ttsiodras">
                <img border="1" src="github.png" alt='GitHub member ttsiodras' title='GitHub member ttsiodras'>
            </a>
        </div>
        <!--div style='float:left; margin-left:1em'>
            <a target="_blank" href="https://projecteuler.net/profile/ttsiodras.png">
                <img src="https://projecteuler.net/profile/ttsiodras.png" alt='Project Euler member ttsiodras' title='Project Euler member ttsiodras'>
            </a>
        </div-->
    </div>
    <div style='clear:both; margin-bottom:0.5em'></div>

<!-- Used to do this with float:right, but Opera Mini shows nothing with it... back to tables :-( -->
<table summary="Footer" width="100%" border="0"><tr><td><a href="index.html">Back to index</a>&nbsp;&nbsp;<a href="cv.pdf">My CV</a></td><td align="right"><em>Last update on: Sat Feb 5 12:13:09 2022</em></td></tr></table>

            <hr style="margin-bottom: 1em">
            <p id="disqus_thread">
                The comments on this website require the use of JavaScript. Perhaps your browser isn't
                JavaScript capable or the script is not being run for another reason. If you're
                interested in reading the comments or leaving a comment behind please try again with a
                different browser or from a different connection.
            </p>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'ttsiodras';
                var disqus_identifier = '../content/coverage.content';

                (function() {
                    'use strict';

                    /**
                     * This method will handle the click on the button to load the comments. It will remove the
                     * button and execute the original Disqus script for loading the comments.
                     */
                    function button_clickHandler(event) {
                        // We need to get the button element, we could also use the target property of the event
                        // but this will do just as well
                        var button = document.getElementById('disqus_thread');
                        // Now we will have to recreate the div element we removed from the HTML. We will place
                        // it into the DOM like we did when we created the button
                        var disqusContainer = document.createElement('div');
                        button.parentNode.insertBefore(disqusContainer, button);
                        button.parentNode.removeChild(button);

                        // The div element will need to have the disqus_thread id as this is required for Disqus,
                        // it is the way their code identifies the element in which the comments can be displayed
                        disqusContainer.id = 'disqus_thread';

                        // Now we can execute the original Disqus code
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    }

                    /**
                     * This method will initialize the module. It will replace the JavaScript dependency message
                     * with a button which will allow the visitor to load the comments.
                     */
                    function init() {
                        // Try to get the element we used to display the message about the JavaScript dependency
                        var placeholder = document.getElementById('disqus_thread');
                        // If we didn't get the placeholder element we will stop setting up the button to load
                        // the comments
                        if (placeholder == null) {
                            return;
                        }

                        // The placeholder was found, now we can create the button which will allow the visitor to
                        // load the comments
                        var button = document.createElement('button');
                        button.appendChild(document.createTextNode('Click here to see the comments (powered by Disqus)'));
                        button.addEventListener('click', button_clickHandler.bind(this));

                        // We will insert the button before the placeholder and once the button has been placed in
                        // the DOM we will remove the placeholder
                        placeholder.parentNode.insertBefore(button, placeholder);
                        placeholder.parentNode.removeChild(placeholder);

                        // The placeholder used to have the id which can be reference by an anchor element, to make
                        // sure we don't break this functionality we will apply the id to our newly created button
                        button.id = 'disqus_thread';
                    }

                    // Setup the module
                    init();
                })();
            </script>
        </div>
    </div>
</body>
</html>
