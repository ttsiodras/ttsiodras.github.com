<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://www.thanassis.space/buildWikipediaOffline.html">
<meta name="author" content="Thanassis Tsiodras">
<meta name="author" content="Athanasios Tsiodras">
<meta name="author" content="ttsiod">
<meta name="author" content="ttsiodras">
<meta name="description" content="Building a (fast) Wikipedia offline reader">
<link type="text/css" rel="stylesheet" href="final-code-wavetheory-lightbox.css">
<link type="application/rss+xml" rel="alternate" href="rss.xml" title="Coding and administration articles by ttsiodras">
<title>Building a (fast) Wikipedia offline reader</title>
</head>
<body>
    <div class="well" id="Page">
        <div id="Banner">Building a (fast) Wikipedia offline reader</div>
        <div id="MainContent">
              <em>In two days... (August 2007)</em>
<h2>Changelog:</h2>
<table border="0" summary="Changelog">
<tr valign="top"><td width="20%"><em>August 13, 2007:</em></td><td><A href="https://tech.slashdot.org/story/07/08/13/1939231/Building-a-Fast-Wikipedia-Offline-Reader">Slashdotted!</A></td></tr>
<tr valign="top"><td><em>August 22, 2007:</em></td><td>Fixed bugs with "extreme" links in some wiki text<br></td></tr>
<tr valign="top"><td><em>September 9, 2007:</em></td><td>Introduced extra script to install the templates used by a page (improves rendering of some pages)<br></td></tr>
<tr valign="top"><td><em>September 17, 2007:</em></td><td>It appears that woc.fslab.de (the site offering the standalone wiki renderer)
is down. Until they come back up, you can download the latest snapshot
of the renderer <A href="mediawiki_sa.tar.7z">here</a>. </td></tr>
<tr valign="top"><td><em>October 21, 2007:</em></td><td>I found an article whose wiki text caused the woc.fslab.de parser to abort - modified <tt>show.pl</tt> to use the plain wiki content in that case.</td></tr>
<tr valign="top"><td><em>March 31, 2008:</em></td><td>Robin Paulson notified me that the same process can be used to install Wiktionary offline!</td></tr>
<tr valign="top"><td><em>April 10, 2009:</em></td><td>Ivan Reyes found out why some wiki texts caused the woc.fslab.de parser to fail, mediawiki_sa.tar.7z updated. Thanks, Ivan!</td></tr>
<tr valign="top"><td><em>September 9, 2009:</em></td><td>Meng WANG made some modifications for searching in the Chinese (and probably other non-English) wikipedias.</td></tr>
<tr valign="top"><td><em>September 19, 2009:</em></td><td>James Somers added caching of LaTEX-made images. His patch is available <a href="math.php.diff">here</a>.</td></tr>
<tr valign="top"><td><em>November 6, 2009:</em></td><td>The woc.fslab.de repository is apparently no longer accessible... I also found out that PHP now has "namespace" as a keyword, and that the old fslab.de tarball has PHP code that uses a "class Namespace". I therefore patched it to make it work with today's PHP interpreters (the updated woc.fslab.de tarball is <a href="mediawiki_sa.tar.7z">here</a>).
</td></tr>
</table>
<h2>Executive summary</h2>
It's strong points:
<ul>
<li>Very fast searching
<li>Keyword (actually, title words) based searching
<li>Search produces multiple possible articles: you can choose amongst them
<li>LaTEX based rendering for Mathematics (thanks to the guys at woc.fslab.de)
<li>Harddisk space is minimal: the original .bz2 file (split in pieces) plus the index built through Xapian
<li>Orders of magnitude faster to install (a matter of hours) compared to loading the "dump" into MySQL
</ul>
Here's a screenshot:
<div class="scrollableContainer">
<img src="offline.wikipedia.png" alt="screenshot" width="628" height="395">
</div>
<h2>What this is and why I built it</h2>
  <a href="https://www.wikipedia.org">Wikipedia</a> needs no introductions: it is one of the best - if not the 
  best - encyclopedias, and it's freely available for everyone.
  <p><em>Everyone</em> can be a relative term, however... It implies availability of an Internet connection. 
  This is not always the case; for example, many people would love to have Wikipedia on their laptop, since
  this would allow them to instantly check for things they want regardless of their location (business trips,
  hotels, firewalled meeting rooms, etc).
  Others simply don't have an Internet connection - or they don't want to dial up one every time they
  need to look something up.
  <p>
  Up to now, installing a local copy of Wikipedia is not for the faint of heart: it requires a LAMP or
  WAMP installation (Linux/Windows, Apache, MySQL, php), and it also requires a tedious - and VERY LENGTHY
  procedure that transforms the "pages/articles" Wikipedia dump file into data of a MySQL database.
  When I say *lengthy*, I mean it: last time I did this, it took my Pentium4 3GHz machine more than a day
  to import Wikipedia's XML dump into MySQL. 36 hours, to be precise. 
  <p>
  The result of the import process was also not exactly what I wanted: I could search for an article, 
  if I knew it's exact name; but I couldn't use parts of the name to search; if you don't use the exact title, 
  you get nothing. 
  To allow these "free-style" searches to work, one must create the search tables - which I'm told, takes 
  days to build. DAYS!
  <p>
  Wouldn't it be perfect, if we could use the wikipedia "dump" data JUST as they arrive after the download?
  Without creating a much larger (space-wise) MySQL database? And also be able to search for parts of title 
  names and get back lists of titles with "similarity percentages"?
  <p>
  Follow me...
  <h2>Identifying the tools</h2>
  First, let's try to keep this as simple as possible. We'll try to avoid using large, complex tools.
  If possible, we'll do it using only ready made tools and scripting languages (Perl, Python, PHP). 
  If we need something that runs fast, we'll use C/C++. 
  <p>
  What do we need to pull this through?
  <ul>
  <li><b>The "pages/articles" dump file</b>
  <br>Right now (August, 2007) the file is a 2.9GB download,
  always available from <a href="https://download.wikimedia.org/enwiki/">here</a>. I set this to download overnight at 
  my work, using wget and rate-limiting it to 80KB/sec - to keep my sysadmin at ease. It downloaded
  in 10 hours - I proceeded to burn it to a DVD and brought it back home.<br><br>
  <li><b>Parsing the dump</b><br>
  This file is just a big XML file - parsing it, through any SAX parser is child's play. We basically only
  care about two elements, title and text: This command for example...
  <pre class="o">
  <b>bash$</b> bzcat enwiki-20070802-pages-articles.xml.bz2 | head -10000 | \
    grep -A 100 '&lt;title&gt;Anarch' | less
  </pre>
  ... shows a piece of the data we need to parse:
  <pre>
&lt;title&gt;Anarchism&lt;/title&gt;
  &lt;id&gt;12&lt;/id&gt;
  &lt;revision&gt;
    &lt;id&gt;149030244&lt;/id&gt;
    &lt;timestamp&gt;2007-08-03T23:24:05Z&lt;/timestamp&gt;
    &lt;contributor&gt;
      &lt;username&gt;Jacob Haller&lt;/username&gt;
      &lt;id&gt;164072&lt;/id&gt;
    &lt;/contributor&gt;
    &lt;comment&gt;/* Four monopolies */&lt;/comment&gt;
    &lt;text xml:space="preserve"&gt;{{dablink|&quot;Anarchist&quot; redirects here. For the 
    comic book character, see [[Anarchist (comics)]].}} {{toolong}} {{disputed}} 
    {{Anarchism}} '''Anarchism''' is a [[political philosophy]] or group of 
    philosophies 
  </pre>
  We basically need to work with the <tt>&lt;title&gt;</tt> and the <tt>&lt;text&gt;</tt> contents;
  that's all the viewer will need: search using the title (and parts of it), and watch the data of 
  the <tt>&lt;text&gt;</tt> section.<p>
  This XML format is in fact so simple to parse, that we don't even need a full-blown SAX parser: we can do it via
  regular expressions: search for &lt;text&gt;, and keep reading until we meet &lt;/text&gt;.<br>
  <li><b>Seeking in the dump file</b><br>
  Hmm... We would certainly prefer not to use MySQL or any other database, since we are only <b>*reading*</b>
  Wikipedia, not writing into it. If only we could seek inside this huge .xml.bz2 file...
  <p>
  Turns out we can do something VERY close: we can use the bzip2recover tool (part of bzip2 distribution) to
  "recover" the individual parts of this compressed file: Basically, BZIP splits its input into 900K (by default)
  size blocks, and compresses each of them individually. bzip2recover seeks out a "magic" signature that
  identifies the beginning of each block, and dumps each block it finds as an individual "recNumberOriginalname" file.
  <p>
  What this means, in plain English, is that we can convert the huge downloaded .bz2 file to a large set
  of small (smaller than 1MB) files, each one individually decompressible! This process is fast (since it 
  involves almost no CPU calculations - it took 20min on my Pentium4 3GHz) and doesn't waste space: you can remove the original 2.9GB file 
  when bzip2recover completes.
  The generated files (13778 in my case) occupy equal space: 2.9GB.
  <p>
  <em>(Note: to answer to some Slashdot readers, yes, of course we have to take into account that a &lt;text&gt;
  section might be split across "block-boundaries" and that our "decoding" scripts must account for that;
  as for the possibility of the element names (i.e. &lt;text&gt; or &lt;title&gt; being split, it is non
  existent - compressing algorithms always take repetitions into account, and store references to previous
  appearances instead of the original texts themselves - since the element names appear all the time, they will
  not be split - hopefully :&#x2011;)</em>
  <li><b>Building a search index</b><br>
  All we need to do, is to use the words in the title as an "index" to the text. We basically want to
  associate each title (and its words), with the small .bz2 file it belongs in! Searching for the specific title
  inside the small .bz2 file will take almost no time - it will decompress in less than half a second, since it is 
  very small!<p>
  How do we associate a set of words with a "target"? We need a custom search engine... Looking
  around for an open-source search engine proved fruitful immediately: <b>Xapian</b>
  is a blindingly-fast, simple to use C++ engine. It took me 20 minutes to look in the code of its examples, 
  and I quickly realized that <a href="quickstartindex.cc">this code</a> fits the profile!

<div class='codegenWrapper'>
<pre><tt><span class="comment">/* quickstartindex.cc: Simplest possible indexer */</span>

<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;xapian.h&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;iostream&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;string&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;vector&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;cctype&gt;</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;algorithm&gt;</span>

<span class="keyword">using</span><span class="normal"> </span><span class="keyword">namespace</span><span class="normal"> std</span><span class="symbol">;</span>

<span class="preproc">#define</span><span class="normal"> MAX_KEY </span><span class="number">230</span>

<span class="preproc">#define</span><span class="normal"> SPLIT_TITLE_INTO_KEYWORDS</span>

<span class="comment">// Split a string into its tokens, based on the given delimiters</span>
<span class="type">void</span><span class="normal"> </span><span class="function">Tokenize</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> string</span><span class="symbol">&amp;</span><span class="normal"> str</span><span class="symbol">,</span><span class="normal"> vector</span><span class="symbol">&lt;</span><span class="normal">string</span><span class="symbol">&gt;&amp;</span><span class="normal"> tokens</span><span class="symbol">,</span><span class="normal"> </span>
<span class="normal">              </span><span class="keyword">const</span><span class="normal"> string</span><span class="symbol">&amp;</span><span class="normal"> delimiters</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="comment">// Skip delimiters at beginning.</span>
<span class="normal">    string</span><span class="symbol">::</span><span class="usertype">size_type</span><span class="normal"> lastPos </span><span class="symbol">=</span><span class="normal"> str</span><span class="symbol">.</span><span class="function">find_first_not_of</span><span class="symbol">(</span><span class="normal">delimiters</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0</span><span class="symbol">);</span>
<span class="normal">    </span><span class="comment">// Find first "non-delimiter".</span>
<span class="normal">    string</span><span class="symbol">::</span><span class="usertype">size_type</span><span class="normal"> pos     </span><span class="symbol">=</span><span class="normal"> str</span><span class="symbol">.</span><span class="function">find_first_of</span><span class="symbol">(</span><span class="normal">delimiters</span><span class="symbol">,</span><span class="normal"> lastPos</span><span class="symbol">);</span>

<span class="normal">    </span><span class="keyword">while</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">string</span><span class="symbol">::</span><span class="normal">npos </span><span class="symbol">!=</span><span class="normal"> pos </span><span class="symbol">||</span><span class="normal"> string</span><span class="symbol">::</span><span class="normal">npos </span><span class="symbol">!=</span><span class="normal"> lastPos</span><span class="symbol">)</span>
<span class="normal">    </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="comment">// Found a token, add it to the vector.</span>
<span class="normal">        tokens</span><span class="symbol">.</span><span class="function">push_back</span><span class="symbol">(</span><span class="normal">str</span><span class="symbol">.</span><span class="function">substr</span><span class="symbol">(</span><span class="normal">lastPos</span><span class="symbol">,</span><span class="normal"> pos </span><span class="symbol">-</span><span class="normal"> lastPos</span><span class="symbol">));</span>
<span class="normal">        </span><span class="comment">// Skip delimiters.  Note the "not_of"</span>
<span class="normal">        lastPos </span><span class="symbol">=</span><span class="normal"> str</span><span class="symbol">.</span><span class="function">find_first_not_of</span><span class="symbol">(</span><span class="normal">delimiters</span><span class="symbol">,</span><span class="normal"> pos</span><span class="symbol">);</span>
<span class="normal">        </span><span class="comment">// Find next "non-delimiter"</span>
<span class="normal">        pos </span><span class="symbol">=</span><span class="normal"> str</span><span class="symbol">.</span><span class="function">find_first_of</span><span class="symbol">(</span><span class="normal">delimiters</span><span class="symbol">,</span><span class="normal"> lastPos</span><span class="symbol">);</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="cbracket">}</span>

<span class="comment">// We will perform case insensitive searches, </span>
<span class="comment">// so we need a function to lowcase() a string</span>
<span class="type">char</span><span class="normal"> </span><span class="function">to_lower</span><span class="normal"> </span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> </span><span class="type">char</span><span class="normal"> c</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="keyword">return</span><span class="normal"> </span><span class="function">tolower</span><span class="symbol">(</span><span class="normal">c</span><span class="symbol">);</span><span class="normal"> </span><span class="cbracket">}</span>
<span class="type">void</span><span class="normal"> </span><span class="function">lowcase</span><span class="symbol">(</span><span class="normal">string</span><span class="symbol">&amp;</span><span class="normal"> s</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span><span class="normal"> </span><span class="function">transform</span><span class="symbol">(</span><span class="normal">s</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> s</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">(),</span><span class="normal"> s</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">(),</span><span class="normal"> to_lower</span><span class="symbol">);</span><span class="normal"> </span><span class="cbracket">}</span>

<span class="type">int</span><span class="normal"> </span><span class="function">main</span><span class="symbol">(</span><span class="type">int</span><span class="normal"> argc</span><span class="symbol">,</span><span class="normal"> </span><span class="type">char</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">argv</span><span class="symbol">)</span>
<span class="cbracket">{</span>
<span class="normal">    </span><span class="type">unsigned</span><span class="normal"> total </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span><span class="symbol">;</span>
<span class="normal">    </span><span class="keyword">try</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        </span><span class="comment">// Make the database</span>
<span class="normal">        Xapian</span><span class="symbol">::</span><span class="usertype">WritableDatabase</span><span class="normal"> </span><span class="function">database</span><span class="symbol">(</span><span class="string">"db/"</span><span class="symbol">,</span><span class="normal"> Xapian</span><span class="symbol">::</span><span class="normal">DB_CREATE_OR_OPEN</span><span class="symbol">);</span>

<span class="normal">        </span><span class="usertype">string</span><span class="normal"> docId</span><span class="symbol">;</span>
<span class="normal">        </span><span class="keyword">while</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">            </span><span class="usertype">string</span><span class="normal"> title</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">cin</span><span class="symbol">.</span><span class="function">eof</span><span class="symbol">())</span><span class="normal"> </span><span class="keyword">break</span><span class="symbol">;</span>
<span class="normal">            </span><span class="function">getline</span><span class="symbol">(</span><span class="normal">cin</span><span class="symbol">,</span><span class="normal"> title</span><span class="symbol">);</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> l </span><span class="symbol">=</span><span class="normal"> title</span><span class="symbol">.</span><span class="function">length</span><span class="symbol">();</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">l</span><span class="symbol">&gt;</span><span class="number">4</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> title</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">]</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">'#'</span><span class="normal"> </span><span class="symbol">&amp;&amp;</span><span class="normal"> title</span><span class="symbol">.</span><span class="function">substr</span><span class="symbol">(</span><span class="normal">l</span><span class="symbol">-</span><span class="number">4</span><span class="symbol">,</span><span class="normal"> </span><span class="number">4</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="string">".bz2"</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                docId </span><span class="symbol">=</span><span class="normal"> title</span><span class="symbol">.</span><span class="function">substr</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">,</span><span class="normal"> string</span><span class="symbol">::</span><span class="normal">npos</span><span class="symbol">);</span><span class="normal">  </span>
<span class="normal">                </span><span class="keyword">continue</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="usertype">string</span><span class="normal"> Title </span><span class="symbol">=</span><span class="normal"> title</span><span class="symbol">;</span>
<span class="normal">            </span><span class="function">lowcase</span><span class="symbol">(</span><span class="normal">title</span><span class="symbol">);</span>

<span class="normal">            </span><span class="comment">// Make the document</span>
<span class="normal">            Xapian</span><span class="symbol">::</span><span class="usertype">Document</span><span class="normal"> newdocument</span><span class="symbol">;</span>

<span class="normal">            </span><span class="comment">// Target: filename and the exact title used</span>
<span class="normal">            </span><span class="usertype">string</span><span class="normal"> target </span><span class="symbol">=</span><span class="normal"> docId </span><span class="symbol">+</span><span class="normal"> </span><span class="function">string</span><span class="symbol">(</span><span class="string">":"</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> Title</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">target</span><span class="symbol">.</span><span class="function">length</span><span class="symbol">()&gt;</span><span class="normal">MAX_KEY</span><span class="symbol">)</span>
<span class="normal">                target </span><span class="symbol">=</span><span class="normal"> target</span><span class="symbol">.</span><span class="function">substr</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> MAX_KEY</span><span class="symbol">);</span>
<span class="normal">            newdocument</span><span class="symbol">.</span><span class="function">set_data</span><span class="symbol">(</span><span class="normal">target</span><span class="symbol">);</span>

<span class="normal">            </span><span class="comment">// 1st Source: the lowercased title</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">title</span><span class="symbol">.</span><span class="function">length</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> MAX_KEY</span><span class="symbol">)</span>
<span class="normal">                title </span><span class="symbol">=</span><span class="normal"> title</span><span class="symbol">.</span><span class="function">substr</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> MAX_KEY</span><span class="symbol">);</span>
<span class="normal">            newdocument</span><span class="symbol">.</span><span class="function">add_posting</span><span class="symbol">(</span><span class="normal">title</span><span class="symbol">.</span><span class="function">c_str</span><span class="symbol">(),</span><span class="normal"> </span><span class="number">1</span><span class="symbol">);</span>

<span class="normal">            </span><span class="usertype">vector&lt;string&gt;</span><span class="normal"> keywords</span><span class="symbol">;</span>
<span class="normal">            </span><span class="function">Tokenize</span><span class="symbol">(</span><span class="normal">title</span><span class="symbol">,</span><span class="normal"> keywords</span><span class="symbol">,</span><span class="normal"> </span><span class="string">" "</span><span class="symbol">);</span>

<span class="normal">            </span><span class="comment">// 2nd source: All the title's lowercased words</span>
<span class="normal">            </span><span class="type">int</span><span class="normal"> cnt </span><span class="symbol">=</span><span class="normal"> </span><span class="number">2</span><span class="symbol">;</span>
<span class="normal">            </span><span class="keyword">for</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">vector</span><span class="symbol">&lt;</span><span class="normal">string</span><span class="symbol">&gt;::</span><span class="usertype">iterator</span><span class="normal"> it</span><span class="symbol">=</span><span class="normal">keywords</span><span class="symbol">.</span><span class="function">begin</span><span class="symbol">();</span><span class="normal"> </span>
<span class="normal">                it</span><span class="symbol">!=</span><span class="normal">keywords</span><span class="symbol">.</span><span class="function">end</span><span class="symbol">();</span><span class="normal"> it</span><span class="symbol">++)</span><span class="normal"> </span>
<span class="normal">            </span><span class="cbracket">{</span>
<span class="normal">                </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">(</span><span class="normal">it</span><span class="symbol">-&gt;</span><span class="function">length</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&gt;</span><span class="normal"> MAX_KEY</span><span class="symbol">)</span>
<span class="normal">                    </span><span class="symbol">*</span><span class="normal">it </span><span class="symbol">=</span><span class="normal"> it</span><span class="symbol">-&gt;</span><span class="function">substr</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">,</span><span class="normal"> MAX_KEY</span><span class="symbol">);</span>
<span class="normal">                newdocument</span><span class="symbol">.</span><span class="function">add_posting</span><span class="symbol">(</span><span class="normal">it</span><span class="symbol">-&gt;</span><span class="function">c_str</span><span class="symbol">(),</span><span class="normal"> cnt</span><span class="symbol">++);</span>
<span class="normal">            </span><span class="cbracket">}</span>

<span class="normal">            </span><span class="keyword">try</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                </span><span class="comment">//cout &lt;&lt; "Added " &lt;&lt; title &lt;&lt; endl;</span>
<span class="normal">                </span><span class="comment">// Add the document to the database</span>
<span class="normal">                database</span><span class="symbol">.</span><span class="function">add_document</span><span class="symbol">(</span><span class="normal">newdocument</span><span class="symbol">);</span>
<span class="normal">            </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">catch</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> Xapian</span><span class="symbol">::</span><span class="usertype">Error</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">error</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                cout </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="string">"Exception: "</span><span class="normal">  </span><span class="symbol">&lt;&lt;</span><span class="normal"> error</span><span class="symbol">.</span><span class="function">get_msg</span><span class="symbol">();</span>
<span class="normal">                cout </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">When adding:</span><span class="specialchar">\n</span><span class="string">"</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> title</span><span class="symbol">;</span>
<span class="normal">                cout </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="string">"</span><span class="specialchar">\n</span><span class="string">Of length "</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> title</span><span class="symbol">.</span><span class="function">length</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> endl</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">            total </span><span class="symbol">++;</span>

<span class="normal">            </span><span class="keyword">if</span><span class="normal"> </span><span class="symbol">((</span><span class="normal">total </span><span class="symbol">%</span><span class="normal"> </span><span class="number">8192</span><span class="symbol">)</span><span class="normal"> </span><span class="symbol">==</span><span class="normal"> </span><span class="number">0</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">                cout </span><span class="symbol">&lt;&lt;</span><span class="normal"> total </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="string">" articles indexed so far"</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> endl</span><span class="symbol">;</span>
<span class="normal">            </span><span class="cbracket">}</span>
<span class="normal">        </span><span class="cbracket">}</span>
<span class="normal">    </span><span class="cbracket">}</span><span class="normal"> </span><span class="keyword">catch</span><span class="symbol">(</span><span class="keyword">const</span><span class="normal"> Xapian</span><span class="symbol">::</span><span class="usertype">Error</span><span class="normal"> </span><span class="symbol">&amp;</span><span class="normal">error</span><span class="symbol">)</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">        cout </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="string">"Exception: "</span><span class="normal">  </span><span class="symbol">&lt;&lt;</span><span class="normal"> error</span><span class="symbol">.</span><span class="function">get_msg</span><span class="symbol">()</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> endl</span><span class="symbol">;</span>
<span class="normal">    </span><span class="cbracket">}</span>
<span class="normal">    cout </span><span class="symbol">&lt;&lt;</span><span class="normal"> total </span><span class="symbol">&lt;&lt;</span><span class="normal"> </span><span class="string">" articles indexed."</span><span class="normal"> </span><span class="symbol">&lt;&lt;</span><span class="normal"> endl</span><span class="symbol">;</span>
<span class="cbracket">}</span>
</tt></pre>

</div>
  This code is based on one of the Xapian examples, one that creates a search index: it is augmented here to start
  from titles (and their words, created by function Tokenize) and provide the filename of the bzip2 block file that 
  contains them. The code expects to read standard input like this:
<pre>
#rec00001enwiki-20070802-pages-articles.xml.bz2 
AlgeriA
AmericanSamoa
AppliedEthics
AccessibleComputing
Anarchism
AfghanistanHistory
AfghanistanGeography
AfghanistanPeople
AfghanistanEconomy
...
...
Topics of note in Atlas Shrugged
Atlas Shrugged
#rec00002enwiki-20070802-pages-articles.xml.bz2
Anthropology
Archaeology
Anomalous Phenomena
...
</pre>
  ...which is easily generated with this script:
<pre class="o">
<b>bash$</b> echo Enter the directory of the recXXXXX...bz2 files
<b>bash$</b> cd wiki-splits
<b>bash$</b> echo Create the index directory
<b>bash$</b> mkdir db
<b>bash$</b> echo Building the index
<b>bash$</b> for i in rec*.bz2 ; do 
	echo \#$i 
	bzcat $i | grep '&lt;title' | \
	 perl -ne 'm/&lt;title&gt;([^&lt;]+)&lt;\/title&gt;/ &amp;&amp; print $1."\n";' 
done | ../quickstartindex
</pre>
  Indexing with Xapian will take some time, depending on the speed of your CPU and the 
  number of cores you have. Expect at least a couple of hours (my single core Pentium4 3GHz 
  took 5 hours to build it).<p>
  Using the Xapian provided <a href="quickstartsearch.cc">quickstartsearch</a> example application, 
  we can now do this:
<pre class="o">
<b>bash$</b> ./quickstartsearch db/ greece
99% [rec00124enwiki-20070802-pages-articles.xml.bz2:Greece]
72% [rec00137enwiki-20070802-pages-articles.xml.bz2:Hellenic Greece]
72% [rec00465enwiki-20070802-pages-articles.xml.bz2:Argos, Greece]
72% [rec00468enwiki-20070802-pages-articles.xml.bz2:Marathon, Greece]
72% [rec00524enwiki-20070802-pages-articles.xml.bz2:Athens, Greece]
72% [rec00583enwiki-20070802-pages-articles.xml.bz2:Thebes, Greece]
...
</pre>
  Perfect...! Seems to be working!<br>And it didn't require a WEEK to build!<br><br>
<li><b>Showing the wiki markup as nice HTML</b><br>
  Fortunately, I can rely on others for this: the nice people over at woc.fslab.de have created
  a standalone wiki-markup parser which is ready for use! Checking out their code with Subversion...
<pre class="o">
<b>bash$</b> svn co https://fslab.de/svn/wpofflineclient/trunk/mediawiki_sa/ mediawiki_sa
</pre>
  ...allows a quick test:
<pre class="o">
<b>bash$</b> cd mediawiki_sa
<b>bash$</b> php5 testparser.php bonsai.wikimarkup &gt; bonsai.html
</pre>
  Nice and simple.<p>
(<em>Update, September 17, 2007: It appears that woc.fslab.de (the site offering the standalone wiki renderer) 
is down. Until they come back up, you can download the latest snapshot of the renderer <A href="mediawiki_sa.tar.7z">here</a>.</em>)
<li><b>Orchestration</b><br>
  Now we have all the ingredients: we need to "cook" them together, and what better way to do this than to
  use a simple Web front-end (no, NOT a full blown Apache!). We can do this in Perl or Python or whatever... 
  I started with a simple, standalone <a href="mywiki.pl">script</a> in Perl:
<pre class="o">
<b>bash$</b> ./mywiki.pl 
Usage: ./mywiki.pl keyword1 &lt;keyword2&gt; ...
<b>bash$</b> ./mywiki.pl greece
0: (abort)
1: (99%) Greece
2: (72%) Hellenic Greece
3: (72%) Argos, Greece
4: (72%) Marathon, Greece
5: (72%) Athens, Greece
...
Select a number: 2
(firefox starts up, showing the generated HTML file)
</pre>
  This won't suffice, though. One of the reasons people morph into Wikipedians is because they 
  can jump from one article to the next, following the hyperlinks. I built a mini-server (in Python, using Django)
  to accomplish this. You can of course build your own, since the work is indeed too easy... (you can 
  even use CGI to invoke the standalone Perl script). In Django, it only took 80 lines of Python code in the 
  scaffolding to support keyword based searching, choosing one article out of the many possibilities offered
  by 'quickstartsearch', adding a 'search' bar on top of all article pages, etc...
</ul>
<p>
  Anyway, I think I'll stop here. Make sure you have Python, Perl, Php (the big hammers), Xapian 
  and Django (the small ones), install <a href="offline.wikipedia.tar.bz2">this package</a>, and you will be able 
  to enjoy the best (currently) possible offline browsing of Wikipedia. Just untar it, type 'make' and follow the 
  instructions.
<p>
  Version wise - some people asked this - I used the following (but since I am only using simple constructs, I 
  believe other versions will work just fine):
  Perl 5.8.5, Python 2.5, PHP 5.2.1, Xapian 1.0.2 and Django 0.9.6.
<p>
<em><b>Update, September 9, 2007:</b></em> Some of the pages appear less appealing than what they can - they use
wiki templates, which are not installed in woc.fslab.de's renderer by default. These templates are, however, inside
the .bz2 files - all we need to do is install them in the renderer.  If you meet such a page, 
execute <tt>fixTemplatesOfCurrentPage.pl</tt> from within the installation directory: the script (part of the package)
will read the data of the last page shown, and install the necessary templates in the renderer. Simply refresh your
browser, and the templates will then be rendered correctly.
<p>
<em><b>Update, September 17, 2007:</b></em> It appears that woc.fslab.de (the site offering the standalone wiki renderer) 
is down. You can download the latest snapshot of the wiki renderer <A href="mediawiki_sa.tar.7z">here</a>, so 
comment out the subversion checkout command from the Makefile, and just untar this instead.
<p>
<em><b>Update, October 21, 2007:</b></em> I found an article whose wiki text caused the woc.fslab.de parser to abort - modified <tt>show.pl</tt> to use the plain wiki content in that case.<p>
<em><b>Update, March 31, 2008:</b></em> According to Robin Paulson, the same process described here also works for Wiktionary. I didn't even know there was a Wiktionary!... Thanks, Robin!<p>
<em><b>Update, February 27, 2012:</b></em> It is now almost 5 years since I published my technique for offline Wikipedia browsing... Other methods have surfaced in the meantime, and people from the Wikimedia foundation asked me to add a link to <a href="https://www.kiwix.org/">Kiwix</a>: an ongoing effort to create an easy to install, open-source, offline Wikipedia reader. Looks interesting...<p>
<em>P.S. Isn't the world of Open Source amazing? I was able to build this in two days, most of which were spent
searching for the appropriate tools. Simply unbelievable... toying around with these tools and writing less than 200
lines of code, and... presto!</em>
<br>
    <hr>
    <div style='margin-top:1em'>
        <div style='float:left'>
            <a target="_blank" href="https://stackoverflow.com/users/382050/ttsiodras">
                <img src="382050.png" width="208" height="58" alt="profile for ttsiodras at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for ttsiodras at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
            </a>
        </div>
        <div style='float:left; margin-left:1em'>
            <a target="_blank" href="https://github.com/ttsiodras">
                <img border="1" src="github.png" alt='GitHub member ttsiodras' title='GitHub member ttsiodras'>
            </a>
        </div>
        <!--div style='float:left; margin-left:1em'>
            <a target="_blank" href="https://projecteuler.net/profile/ttsiodras.png">
                <img src="https://projecteuler.net/profile/ttsiodras.png" alt='Project Euler member ttsiodras' title='Project Euler member ttsiodras'>
            </a>
        </div-->
    </div>
    <div style='clear:both; margin-bottom:0.5em'></div>

<!-- Used to do this with float:right, but Opera Mini shows nothing with it... back to tables :-( -->
<table summary="Footer" width="100%" border="0"><tr><td>&nbsp;<br><a href="index.html">Index</a><br>&nbsp;</td><td>&nbsp;<br><a href="cv.pdf">CV</a><br>&nbsp;</td><td align="right">&nbsp;<br><em>Updated: Sun Oct 22 14:41:45 2023</em><br>&nbsp;</td></tr></table>

            <hr style="margin-bottom: 1em">
            <p id="disqus_thread">
                The comments on this website require the use of JavaScript. Perhaps your browser isn't
                JavaScript capable; or the script is not being run for another reason. If you're
                interested in reading the comments or leaving a comment behind please try again with a
                different browser or from a different connection.
            </p>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'ttsiodras';
                var disqus_identifier = '../content/buildWikipediaOffline.content';

                (function() {
                    'use strict';

                    /**
                     * This method will handle the click on the button to load the comments. It will remove the
                     * button and execute the original Disqus script for loading the comments.
                     */
                    function button_clickHandler(event) {
                        // We need to get the button element, we could also use the target property of the event
                        // but this will do just as well
                        var button = document.getElementById('disqus_thread');
                        // Now we will have to recreate the div element we removed from the HTML. We will place
                        // it into the DOM like we did when we created the button
                        var disqusContainer = document.createElement('div');
                        button.parentNode.insertBefore(disqusContainer, button);
                        button.parentNode.removeChild(button);

                        // The div element will need to have the disqus_thread id as this is required for Disqus,
                        // it is the way their code identifies the element in which the comments can be displayed
                        disqusContainer.id = 'disqus_thread';

                        // Now we can execute the original Disqus code
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    }

                    /**
                     * This method will initialize the module. It will replace the JavaScript dependency message
                     * with a button which will allow the visitor to load the comments.
                     */
                    function init() {
                        // Try to get the element we used to display the message about the JavaScript dependency
                        var placeholder = document.getElementById('disqus_thread');
                        // If we didn't get the placeholder element we will stop setting up the button to load
                        // the comments
                        if (placeholder == null) {
                            return;
                        }

                        // The placeholder was found, now we can create the button which will allow the visitor to
                        // load the comments
                        var button = document.createElement('button');
                        button.appendChild(document.createTextNode('Click here to see the comments (powered by Disqus)'));
                        button.addEventListener('click', button_clickHandler.bind(this));

                        // We will insert the button before the placeholder and once the button has been placed in
                        // the DOM we will remove the placeholder
                        placeholder.parentNode.insertBefore(button, placeholder);
                        placeholder.parentNode.removeChild(placeholder);

                        // The placeholder used to have the id which can be reference by an anchor element, to make
                        // sure we don't break this functionality we will apply the id to our newly created button
                        button.id = 'disqus_thread';
                    }

                    // Setup the module
                    init();
                })();
            </script>
        </div>
    </div>
</body>
</html>
