<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://www.thanassis.space/thebeast.html">
<meta name="author" content="Thanassis Tsiodras">
<meta name="author" content="Athanasios Tsiodras">
<meta name="author" content="ttsiod">
<meta name="author" content="ttsiodras">
<link type="text/css" rel="stylesheet" href="final-code-wavetheory-lightbox.css">
<link type="application/rss+xml" rel="alternate" href="rss.xml" title="Coding and administration articles by ttsiodras">
<title>Tinkering with electronics</title>
</head>
<body>
    <div class="well" id="Page">
        <div id="Banner">Tinkering with electronics</div>
        <div id="MainContent">
            <a href="//www.reddit.com/r/programming/submit" onclick="window.location = window.location.protocol + '//www.reddit.com/r/programming/submit?url=' + encodeURIComponent(window.location); return false"> <img src="spreddit7.gif" width="75" height="17" alt="submit to programming reddit" border="0"> </a>
            <br>&nbsp;<br>
            <p><em>(August 2017)</em></p>

<h2>Tinkering with electronics</h2>

<p><strong>TL; DR</strong> You'll find below some electronics-related projects that I hacked on
during 2017.</p>

<p>Note that I am a SW guy by vocation - but I must confess that I have become sort of addicted to
electronics-related tinkering! It's so easy <em>(and cheap)</em> to order components online... and then
spend some quality time hacking with them... </p>

<p>What better way is there to learn? :-)</p>

<h3>1. Real-time 3D on an ATmega328P (aka "breadboard Arduino")</h3>

<p>I configured <a href="https://www.youtube.com/watch?v=sNIMCdVOHOM">an ATmega328P on a breadboard</a>,
and had it do <a href="https://www.youtube.com/watch?v=nsqmnkfZtSw">real-time 3D graphics on a SPI-controlled OLED</a>:</p>

<center>
<div class="video-container">
    <iframe
        srcdoc="
            <style>
                body, .full {
                    height: 100%;
                    width: 100%;
                    margin: 0;
                    position: absolute;
                    display: flex;
                    justify-content: center;
                    object-fit: cover;
                }
            </style>
            <a href='https://www.youtube.com/embed/nsqmnkfZtSw?autoplay=1' class='full'>
                <img src='nsqmnkfZtSw.jpg' class='full'/>
                <svg version='1.1' viewBox='0 0 68 48' width='68px' style='position: relative;'>
                    <path d='M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z' fill='#f00'></path>
                    <path d='M 45,24 27,14 27,34' fill='#fff'></path>
                </svg>
            </a>"
        style="max-width: 40em; width: 100%; justify-content: center;"
        frameborder="0" allowfullscreen>
    </iframe>
</div>
</center>

<div style="text-align: center">
<em>Real-time 3D on an ATmega328P on a SPI-controlled OLED</em>
</div>

<p><a href="https://github.com/ttsiodras/3D-on-an-ATmega328p">The code is on GitHub</a>:</p>

<ul>
<li>Fixed point calculations are used, for speed <em>(8 bits for the fractional part)</em>.</li>
<li>The statue data are stored into and read from (at run-time) from the <em>.text</em> segment. The ATmega328P
has 32KB of flash available to store the program code, but only 2K of RAM... So the flash had to be
used to store not just the code, but also the constant <em>(read-only)</em> data of the X,Y and Z coordinates
of the points.</li>
<li>The "design" has a bonus distance indicator - a LED shining brightly when the statue gets close :-)</li>
<li>The code conditionally outputs frames per second (FPS) information over the ATmega328P's serial port.</li>
</ul>

<p>This was the first time I used SPI - and in fact, in two places: (a) the ATmega328P drives the OLED
via its SPI pins, and (b) additionally, the micro-controller itself is programmed via the same SPI pins
through my Raspberry PI2's SPI interface pins. 
Basically, my PI2 sits next to the breadboard, and I use <code>avrdude</code> to flash the code to the ATmega328P. 
This of course means that the SPI pins are shared - either driven by the PI or by the ATmega328P <em>(but not
at the same time)</em>.</p>

<p>If you've never seen <a target="_blank" href="https://github.com/ttsiodras/3D-on-an-ATmega328p/blob/master/cube.ino#L83">fixed-point code before</a>,
it's really quite easy. The values are simply multiplied by a power of two,
depending on how many fractional bits we want to use for them. In my case, 8 fractional bits meant
that the values had to be multiplied by 256 before being used in any computation; and appropriately adjusted
down after every step. For example, if two such values are multiplied, the result must be divided by 256
afterwards - which is easily done by a right shift 8 times.</p>

<p>This is how we used to do things in the "good old days"... and honestly, it was quite fun to do this 
kind of thing again. Admittedly, though, storing the 3D coordinates of the statue's points in ROM
<em>(think: flash)</em> to make things fit... well, that was new:</p>

<div class='codegenWrapper'>
<pre><tt><span class="symbol">...</span>
<span class="preproc">#ifndef</span><span class="normal"> PROGMEM</span>
<span class="preproc">#include</span><span class="normal"> </span><span class="string">&lt;avr/pgmspace.h&gt;</span>
<span class="preproc">#endif</span>

<span class="keyword">const</span><span class="normal"> </span><span class="type">float</span><span class="normal"> points</span><span class="symbol">[][</span><span class="number">3</span><span class="symbol">]</span><span class="normal"> PROGMEM </span><span class="symbol">=</span><span class="normal"> </span><span class="cbracket">{</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="number">0.1312855</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0.11608299999999999</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">0.5005139999999999</span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="normal">    </span><span class="cbracket">{</span><span class="number">0.1759435</span><span class="symbol">,</span><span class="normal"> </span><span class="number">0.08417239999999998</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">0.30605499999999997</span><span class="cbracket">}</span><span class="symbol">,</span>
<span class="symbol">...</span>
<span class="comment">// Read the statue data from the .text segment.</span>
<span class="comment">// Even though the microcontroller has 32KB of .text space, it only</span>
<span class="comment">// has 2K of RAM! The flash that stores the code can be used as storage</span>
<span class="comment">// for our constant data as well.</span>
<span class="type">long</span><span class="normal"> wx </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> </span><span class="function">pgm_read_word_near</span><span class="symbol">(&amp;(</span><span class="normal">points</span><span class="symbol">[</span><span class="normal">pt</span><span class="symbol">][</span><span class="number">0</span><span class="symbol">]));</span>
<span class="type">long</span><span class="normal"> wy </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> </span><span class="function">pgm_read_word_near</span><span class="symbol">(&amp;(</span><span class="normal">points</span><span class="symbol">[</span><span class="normal">pt</span><span class="symbol">][</span><span class="number">1</span><span class="symbol">]));</span>
<span class="type">long</span><span class="normal"> wz </span><span class="symbol">=</span><span class="normal"> </span><span class="symbol">(</span><span class="type">long</span><span class="symbol">)</span><span class="normal"> </span><span class="function">pgm_read_word_near</span><span class="symbol">(&amp;(</span><span class="normal">points</span><span class="symbol">[</span><span class="normal">pt</span><span class="symbol">][</span><span class="number">2</span><span class="symbol">]));</span>
<span class="symbol">...</span>
</tt></pre>
</div>

<p>Even my <a target="_blank"
href="https://en.wikipedia.org/wiki/ZX_Spectrum#ZX_Spectrum_16K.2F48K">ZX Spectrum</a> back in 1986 had
48K of RAM, instead of the ATmega328P's puny 2K! :-)</p>

<p>Then again, it's 8MHz brain may in fact be a good match for the Z80 - I plan to pit them against each
other when I revive my dead Speccy :-)</p>

<p><a name="thebeast"></a></p>

<h3>2. Building the Beast (TM)</h3>

<p>I love my Raspberry PI2 - but when I saw an ad for an Orange PI Zero, I felt it
was the perfect opportunity to build <em>my own ARM server from scratch</em> - in
terms of both SW and HW. What better way is there, to learn the ways of ARM?</p>

<p>So here it is, my geeky brothers and sisters... in all it's <em>"magnificent splendor"</em> - The Beast (TM):</p>

<div style="clear:both; text-align:center; margin: 0em 0em 0em 0em">
<img src="The.Beast.TM.jpg" alt="The Beast (TM)"><p>
<em>The Beast (TM) - 4-core ARM, PI(D)-controlled FAN, I2C 1602, level-shifter, and more!</em>
</div>

<h4>First, make it work</h4>

<p>The 'heart' of the contraption is an Orange PI zero board, carrying an H2+ SoC - which is a 4-core
ARM Cortex A7. The SoC has Ethernet and USB ports - and can run the 4 cores from 240MHz up to
1.2GHz. It also carries 512MB of RAM - all this for around 12Euros...</p>

<p>SW-wise, I used <a href="https://www.armbian.com/">armbian</a>. To make sure 
I remained in control of both the HW and the SW, I in fact compiled and created the armbian
image myself, based on <a href="https://github.com/armbian/build">the excellent Docker-based automation work</a>
done by the amazing people behind armbian. I wrote the image I built to a 4GB SD
card, and booted to a perfectly-running Debian userland.</p>

<p>Things seemed to work fine, originally - until doing some stress-testing
with <a href="https://www.thanassis.space/renderer.html">my renderer</a>. At that point, I witnessed
weird instabilities - and after monitoring the voltage levels on the 5V
line, I quickly realized that the 5Euro power supply I was using - rated at "5V/3A" - would
in fact dip down far below 5V at far less than a 3A draw...</p>

<p>When I used my Raspberry's power supply, all the instabilities disappeared.</p>

<p>So I ordered a 2nd Raspberry PSU - and while waiting, I realized that the SoC's temperature
would rise up to 80C during benchmarking! That was quite a difference to my Raspberry
PI2's maximum of 58C. At that point, to avoid disasters, armbian would downclock the cores
to 240MHz... and performance suffered.</p>

<p>I've never played with fan control of my own making. Good! <em>(rubs hands :-)</em></p>

<h4>Then, make it cool</h4>

<p>The 5V fan and some dirt-cheap heatsinks arrived in a few days. I drilled a hole in
the Orange PI Zero's enclosure, and attached the fan with zip-ties,
blowing cool air directly over the <em>Now-with-Heatsink!</em> SoC:</p>

<div style="clear:both; text-align:center; margin: 0em 0em 0em 0em">
<img src="zipties.jpg" alt="The Beauty"><p>
<em>The Beauty - with a serial port PL2303HX for easy getty-access</em>
</div>

<p>The fan was powered by the 5V GPIO pin - which is in turn "fed" directly
from the USB power jack <em>(the rest of the board runs at 3.3V)</em>.</p>

<p>But the result... was not <em>quite</em> what I wanted.</p>

<h4>Design a control circuit, Luke</h4>

<p>For one, the temperature only dropped by a meagre 10C. The enclosure was simply
not designed for this - and the hot air was more or less "trapped" inside it,
no matter how hard the tiny fan tried to push it out.</p>

<p>In addition, the end result was also too noisy - the fan was on all the time,
and even though it wasn't loud, just like all tiny fans it had a high pitch;
the <em>designed-to-drive-you-mad</em> kind.</p>

<p>There was only one way to handle the noise: I needed a control circuit to switch
the fan on only when the temperature was high enough. And since the SoC runs
at 3.3V, even though the fan had very low current draw, I couldn't just power it
- being a 5V fan - directly from the 3.3V GPIO pins... </p>

<p>Which meant it was time to read up on MOSFETs.</p>

<p>I also decided to lose the enclosure, and setup a breadboard next to the SoC.
The air flow would be significantly better - with preliminary tests indicating
almost an additional 10 degrees worth of difference. With the breadboard close by,
 I would also be able to hack the control circuitry very easily... not to mention
enabling further electronics tinkering in the future.</p>

<p>And how would I keep the whole setup together? Acrylic to the rescue!</p>

<p>Which I've also never worked with before.</p>

<p>Awesome! Let's order some :-)</p>

<div style="clear:both; text-align:center; margin: 0em 0em 0em 0em">
<img src="Orange-PI-Zero-fan-controller.png" alt="the fan control circuit"><p>
<em>The fan's control circuit</em>
</div>

<p>After a bit of reading on the Internet, I set up the breadboard with an
N-channel MOSFET controlling the fan's connection to ground... and the FET's gate
itself being controlled from a GPIO pin. <strong><em>UPDATE</em></strong>: <em><code>/u/jms_nh</code> kindly pointed
me to <a href="https://www.embeddedrelated.com/showarticle/77.php">this article</a> which
reminded me to add a current limiting resistor between the GPIO pin and the
gate of the MOSFET.</em></p>

<p>I then wrote a small Python daemon that read the temperature (via 
<code>/sys/class/thermal/thermal_zone0/temp</code>) and appropriately switched
that GPIO pin on/off.</p>

<p>That worked - the noise finally went away, with the fan "waking up" only
when necessary.</p>

<p>And soon after, I <a href="https://en.wikipedia.org/wiki/PID_controller">started reading about PID controllers</a>
and created a <a href="fan.py">Supervisor-driven Python daemon</a> that used the SoC's
PWM support to control the speed of the fan:</p>

<div class='codegenWrapper'>
<pre><tt><span class="comment">#!/usr/bin/env python2</span>
<span class="preproc">from</span><span class="normal"> __future__ </span><span class="preproc">import</span><span class="normal"> print_function</span>
<span class="preproc">import</span><span class="normal"> os</span><span class="symbol">,</span><span class="normal"> sys</span><span class="symbol">,</span><span class="normal"> time</span>

<span class="keyword">def</span><span class="normal"> </span><span class="function">printAndFlush</span><span class="symbol">(*</span><span class="normal">args</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">kwargs</span><span class="symbol">):</span>
<span class="normal">    </span><span class="keyword">print</span><span class="symbol">(*</span><span class="normal">args</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">kwargs</span><span class="symbol">)</span>
<span class="normal">    sys</span><span class="symbol">.</span><span class="normal">stdout</span><span class="symbol">.</span><span class="function">flush</span><span class="symbol">()</span>

<span class="comment">#####################</span>
<span class="comment"># Parse configuration</span>

<span class="normal">CONFIG_FILE </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"/etc/fan.conf"</span>
<span class="normal">DESIRED </span><span class="symbol">=</span><span class="normal"> </span><span class="number">60</span>
<span class="normal">VERBOSE </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"-v"</span><span class="normal"> </span><span class="keyword">in</span><span class="normal"> sys</span><span class="symbol">.</span><span class="normal">argv</span>

<span class="keyword">if</span><span class="normal"> os</span><span class="symbol">.</span><span class="normal">path</span><span class="symbol">.</span><span class="function">exists</span><span class="symbol">(</span><span class="normal">CONFIG_FILE</span><span class="symbol">):</span>
<span class="normal">    </span><span class="keyword">for</span><span class="normal"> line </span><span class="keyword">in</span><span class="normal"> </span><span class="function">open</span><span class="symbol">(</span><span class="normal">CONFIG_FILE</span><span class="symbol">):</span>
<span class="normal">        </span><span class="keyword">if</span><span class="normal"> line</span><span class="symbol">.</span><span class="function">startswith</span><span class="symbol">(</span><span class="string">'#'</span><span class="symbol">):</span>
<span class="normal">            </span><span class="keyword">continue</span>
<span class="normal">        </span><span class="keyword">try</span><span class="symbol">:</span>
<span class="normal">            data </span><span class="symbol">=</span><span class="normal"> line</span><span class="symbol">.</span><span class="function">split</span><span class="symbol">(</span><span class="string">"="</span><span class="symbol">)</span>
<span class="normal">            varname </span><span class="symbol">=</span><span class="normal"> data</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">].</span><span class="function">strip</span><span class="symbol">().</span><span class="function">lower</span><span class="symbol">()</span>
<span class="normal">            </span><span class="keyword">if</span><span class="normal"> varname </span><span class="symbol">==</span><span class="normal"> </span><span class="string">"temperature"</span><span class="symbol">:</span>
<span class="normal">                DESIRED </span><span class="symbol">=</span><span class="normal"> </span><span class="function">int</span><span class="symbol">(</span><span class="normal">data</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">].</span><span class="function">strip</span><span class="symbol">())</span>
<span class="normal">            </span><span class="keyword">elif</span><span class="normal"> varname </span><span class="symbol">==</span><span class="normal"> </span><span class="string">"verbose"</span><span class="symbol">:</span>
<span class="normal">                VERBOSE </span><span class="symbol">=</span><span class="normal"> </span><span class="function">bool</span><span class="symbol">(</span><span class="function">eval</span><span class="symbol">(</span><span class="normal">data</span><span class="symbol">[</span><span class="number">1</span><span class="symbol">].</span><span class="function">strip</span><span class="symbol">()))</span>
<span class="normal">        </span><span class="keyword">except</span><span class="symbol">:</span>
<span class="normal">            </span><span class="keyword">pass</span>

<span class="keyword">def</span><span class="normal"> </span><span class="function">info</span><span class="symbol">(*</span><span class="normal">args</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">kwargs</span><span class="symbol">):</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> VERBOSE</span><span class="symbol">:</span>
<span class="normal">        </span><span class="function">printAndFlush</span><span class="symbol">(*</span><span class="normal">args</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">**</span><span class="normal">kwargs</span><span class="symbol">)</span>

<span class="keyword">if</span><span class="normal"> os</span><span class="symbol">.</span><span class="function">getenv</span><span class="symbol">(</span><span class="string">"TZ"</span><span class="symbol">)</span><span class="normal"> </span><span class="keyword">is</span><span class="normal"> None</span><span class="symbol">:</span>
<span class="normal">    os</span><span class="symbol">.</span><span class="function">putenv</span><span class="symbol">(</span><span class="string">"TZ"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">open</span><span class="symbol">(</span><span class="string">"/etc/timezone"</span><span class="symbol">).</span><span class="function">read</span><span class="symbol">().</span><span class="function">strip</span><span class="symbol">())</span>
<span class="function">printAndFlush</span><span class="symbol">(</span><span class="string">"[-] Fan daemon started at"</span><span class="symbol">,</span><span class="normal"> time</span><span class="symbol">.</span><span class="function">ctime</span><span class="symbol">())</span>
<span class="function">printAndFlush</span><span class="symbol">(</span><span class="string">"[-] Target temperature set at"</span><span class="symbol">,</span><span class="normal"> </span><span class="function">str</span><span class="symbol">(</span><span class="normal">DESIRED</span><span class="symbol">)+</span><span class="string">"C."</span><span class="symbol">)</span>
<span class="function">printAndFlush</span><span class="symbol">(</span><span class="string">"[-] Verbose logging: "</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"enabled"</span><span class="normal"> </span><span class="keyword">if</span><span class="normal"> VERBOSE </span><span class="keyword">else</span><span class="normal"> </span><span class="string">"disabled"</span><span class="symbol">)</span>

<span class="comment">###########</span>
<span class="comment"># Setup PWM</span>

<span class="normal">setup_is_needed </span><span class="symbol">=</span><span class="normal"> False</span>
<span class="normal">moduleLines </span><span class="symbol">=</span><span class="normal"> os</span><span class="symbol">.</span><span class="function">popen</span><span class="symbol">(</span><span class="string">"/sbin/lsmod | grep 'p[w]m'"</span><span class="symbol">).</span><span class="function">readlines</span><span class="symbol">()</span>
<span class="keyword">if</span><span class="normal"> </span><span class="keyword">not</span><span class="normal"> moduleLines </span><span class="keyword">or</span><span class="normal"> </span><span class="keyword">not</span><span class="normal"> moduleLines</span><span class="symbol">[</span><span class="number">0</span><span class="symbol">].</span><span class="function">startswith</span><span class="symbol">(</span><span class="string">'pwm_sunxi_opi0'</span><span class="symbol">):</span>
<span class="normal">    folder </span><span class="symbol">=</span><span class="normal"> os</span><span class="symbol">.</span><span class="normal">path</span><span class="symbol">.</span><span class="function">dirname</span><span class="symbol">(</span><span class="normal">os</span><span class="symbol">.</span><span class="normal">path</span><span class="symbol">.</span><span class="function">realpath</span><span class="symbol">(</span><span class="normal">__file__</span><span class="symbol">))</span>
<span class="normal">    </span><span class="keyword">try</span><span class="symbol">:</span>
<span class="normal">        os</span><span class="symbol">.</span><span class="function">chdir</span><span class="symbol">(</span><span class="normal">folder</span><span class="symbol">)</span>
<span class="normal">    </span><span class="keyword">except</span><span class="normal"> OSError</span><span class="symbol">:</span>
<span class="normal">        </span><span class="function">printAndFlush</span><span class="symbol">(</span><span class="string">"[x] Failed to chdir to folder with PWM module..."</span><span class="symbol">)</span>
<span class="normal">        sys</span><span class="symbol">.</span><span class="function">exit</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">info</span><span class="symbol">(</span><span class="string">"[-] Loading PWM module... (pwm-sunxi-opi0.ko)"</span><span class="symbol">)</span>
<span class="normal">    </span><span class="keyword">if</span><span class="normal"> </span><span class="number">0</span><span class="normal"> </span><span class="symbol">!=</span><span class="normal"> os</span><span class="symbol">.</span><span class="function">system</span><span class="symbol">(</span><span class="string">"/sbin/insmod ./pwm-sunxi-opi0.ko"</span><span class="symbol">):</span>
<span class="normal">        </span><span class="function">printAndFlush</span><span class="symbol">(</span><span class="string">"[x] Failed to load PWM module... Aborting."</span><span class="symbol">)</span>
<span class="normal">        sys</span><span class="symbol">.</span><span class="function">exit</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span>
<span class="normal">    setup_is_needed </span><span class="symbol">=</span><span class="normal"> True</span>

<span class="keyword">try</span><span class="symbol">:</span>
<span class="normal">    PWM </span><span class="symbol">=</span><span class="normal"> </span><span class="string">"/sys/class/pwm-sunxi-opi0/pwm0"</span>
<span class="normal">    os</span><span class="symbol">.</span><span class="function">chdir</span><span class="symbol">(</span><span class="normal">PWM</span><span class="symbol">)</span>
<span class="keyword">except</span><span class="normal"> OSError</span><span class="symbol">:</span>
<span class="normal">    </span><span class="function">printAndFlush</span><span class="symbol">(</span><span class="string">"[x] Failed to chdir to"</span><span class="symbol">,</span><span class="normal"> PWM</span><span class="symbol">)</span>
<span class="normal">    sys</span><span class="symbol">.</span><span class="function">exit</span><span class="symbol">(</span><span class="number">1</span><span class="symbol">)</span>

<span class="keyword">if</span><span class="normal"> setup_is_needed</span><span class="symbol">:</span>
<span class="normal">    </span><span class="function">info</span><span class="symbol">(</span><span class="string">"[-] Setting up PWM scale from 0 to 100"</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">open</span><span class="symbol">(</span><span class="string">"run"</span><span class="normal"> </span><span class="symbol">,</span><span class="normal"> </span><span class="string">"w"</span><span class="symbol">).</span><span class="function">write</span><span class="symbol">(</span><span class="string">"1"</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">open</span><span class="symbol">(</span><span class="string">"polarity"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"w"</span><span class="symbol">).</span><span class="function">write</span><span class="symbol">(</span><span class="string">"1"</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">open</span><span class="symbol">(</span><span class="string">"prescale"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"w"</span><span class="symbol">).</span><span class="function">write</span><span class="symbol">(</span><span class="string">"2"</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">open</span><span class="symbol">(</span><span class="string">"entirecycles"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"w"</span><span class="symbol">).</span><span class="function">write</span><span class="symbol">(</span><span class="string">"100"</span><span class="symbol">)</span>

<span class="comment">###############</span>
<span class="comment"># PI controller</span>

<span class="normal">I </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span>
<span class="keyword">while</span><span class="normal"> True</span><span class="symbol">:</span>
<span class="normal">    temp </span><span class="symbol">=</span><span class="normal"> </span><span class="function">int</span><span class="symbol">(</span><span class="function">open</span><span class="symbol">(</span><span class="string">"/sys/class/thermal/thermal_zone0/temp"</span><span class="symbol">).</span><span class="function">read</span><span class="symbol">())</span>

<span class="normal">    error </span><span class="symbol">=</span><span class="normal"> temp </span><span class="symbol">-</span><span class="normal"> DESIRED</span>
<span class="normal">    I </span><span class="symbol">=</span><span class="normal"> I </span><span class="symbol">+</span><span class="normal"> error</span>
<span class="normal">    I </span><span class="symbol">=</span><span class="normal"> </span><span class="function">min</span><span class="symbol">(</span><span class="normal">I</span><span class="symbol">,</span><span class="normal"> </span><span class="number">100</span><span class="symbol">)</span>
<span class="normal">    I </span><span class="symbol">=</span><span class="normal"> </span><span class="function">max</span><span class="symbol">(</span><span class="normal">I</span><span class="symbol">,</span><span class="normal"> </span><span class="symbol">-</span><span class="number">100</span><span class="symbol">)</span>
<span class="normal">    PID_target </span><span class="symbol">=</span><span class="normal"> </span><span class="function">int</span><span class="symbol">(</span><span class="normal">error </span><span class="symbol">*</span><span class="normal"> </span><span class="number">4.0</span><span class="normal"> </span><span class="symbol">+</span><span class="normal"> I </span><span class="symbol">*</span><span class="normal"> </span><span class="number">0.4</span><span class="symbol">)</span>

<span class="normal">    </span><span class="keyword">if</span><span class="normal"> PID_target </span><span class="symbol">&lt;</span><span class="normal"> </span><span class="number">0</span><span class="symbol">:</span>
<span class="normal">        target </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span>
<span class="normal">    </span><span class="keyword">else</span><span class="symbol">:</span>
<span class="normal">        target </span><span class="symbol">=</span><span class="normal"> </span><span class="function">min</span><span class="symbol">(</span><span class="number">50</span><span class="symbol">+</span><span class="normal">PID_target</span><span class="symbol">,</span><span class="normal"> </span><span class="number">100</span><span class="symbol">)</span>
<span class="normal">    </span><span class="function">info</span><span class="symbol">(</span><span class="string">"[-] Temp is %dC, setting fan at %d%% (I=%s)"</span><span class="normal"> </span><span class="symbol">%</span><span class="normal"> </span><span class="symbol">(</span>
<span class="normal">        temp</span><span class="symbol">,</span><span class="normal"> target</span><span class="symbol">,</span><span class="normal"> </span><span class="function">str</span><span class="symbol">(</span><span class="normal">I</span><span class="symbol">)))</span>
<span class="normal">    </span><span class="function">open</span><span class="symbol">(</span><span class="string">"activecycles"</span><span class="symbol">,</span><span class="normal"> </span><span class="string">"w"</span><span class="symbol">).</span><span class="function">write</span><span class="symbol">(</span><span class="function">str</span><span class="symbol">(</span><span class="normal">target</span><span class="symbol">))</span>
<span class="normal">    time</span><span class="symbol">.</span><span class="function">sleep</span><span class="symbol">(</span><span class="number">4</span><span class="symbol">)</span>
</tt></pre>
</div>

<div class='codegenWrapper'>
<pre><tt><span class="normal">$ cat /etc/fan</span><span class="symbol">.</span><span class="normal">conf </span>
<span class="comment"># Configuration file for my custom fan daemon</span>

<span class="normal">temperature </span><span class="symbol">=</span><span class="normal"> </span><span class="number">65</span>
<span class="normal">verbose </span><span class="symbol">=</span><span class="normal"> </span><span class="number">0</span>


<span class="normal">$ sudo cat /etc/supervisor/conf</span><span class="symbol">.</span><span class="normal">d/fan</span><span class="symbol">.</span><span class="normal">conf </span>
<span class="symbol">[</span><span class="normal">program</span><span class="symbol">:</span><span class="normal">fan</span><span class="symbol">]</span>
<span class="keyword">command</span><span class="symbol">=</span><span class="normal">/root/bin</span><span class="symbol">.</span><span class="normal">local/fan</span><span class="symbol">.</span><span class="normal">py</span>
<span class="variable">autostart</span><span class="symbol">=</span><span class="keyword">true</span>
<span class="variable">autorestart</span><span class="symbol">=</span><span class="keyword">true</span>
<span class="variable">stderr_logfile</span><span class="symbol">=</span><span class="normal">/var/log/fan</span><span class="symbol">.</span><span class="normal">stderr</span><span class="symbol">.</span><span class="normal">log</span>
<span class="variable">stdout_logfile</span><span class="symbol">=</span><span class="normal">/var/log/fan</span><span class="symbol">.</span><span class="normal">stdout</span><span class="symbol">.</span><span class="normal">log    </span>


<span class="normal">$ sudo supervisorctl start fan</span>

<span class="normal">$ sudo tail /var/log/fan</span><span class="symbol">.</span><span class="normal">stdout</span><span class="symbol">.</span><span class="normal">log </span>
<span class="symbol">[</span><span class="normal">-</span><span class="symbol">]</span><span class="normal"> Fan daemon started at Fri Aug  </span><span class="number">4</span><span class="normal"> </span><span class="number">11</span><span class="symbol">:</span><span class="number">47</span><span class="symbol">:</span><span class="number">47</span><span class="normal"> </span><span class="number">2017</span>
<span class="symbol">[</span><span class="normal">-</span><span class="symbol">]</span><span class="normal"> Target temperature </span><span class="keyword">set</span><span class="normal"> at 65C</span><span class="symbol">.</span>
<span class="symbol">[</span><span class="normal">-</span><span class="symbol">]</span><span class="normal"> Verbose logging</span><span class="symbol">:</span><span class="normal">  disabled</span>

</tt></pre>
</div>

<p>The SW parts were easy - Python allows for rapid development. The HW parts of PWM
support depended on a <a href="https://github.com/iboguslavsky/pwm-sunxi-opi0">kind gentleman's device driver</a>
that exposes the OPIZero's PWM functionality <em>(basically, the serial connection's RX pin
becomes a PWM pin)</em>. I had to re-program the FEX file of the SoC to disable the default serial
pins <em>(since the RX one was used for the PWM signal)</em> and configure the serial to
use two other GPIO pins. </p>

<p>Yes, I can't live without my UART! Where would I run my <code>getty</code> otherwise!<br>
SSH? Get off my lawn, kid!</p>

<p><em>(Just kiddin. Sort of :-)</em></p>

<h4>The 1602 screen and the shifter</h4>

<p>I played with UARTs, I played with SPI...</p>

<p>Time for I2C!</p>

<p>Not having a screen attached, meant that The Beast was more or less isolated - unless I
<code>ssh</code>-ed or <code>minicom</code>-ed inside it. </p>

<p>I've seen these 1602 LCD screens everywhere, pretty much all my life... but never
played with one; this was the perfect opportunity to combine that desire with I2C
tinkering.</p>

<p>And in the meantime, the transparent acrylic sheets had arrived - together
with the standoffs and the nuts-and-bolts-y things. I failed somewhat at cutting
the acrylic properly - it broke at an angle ; but I managed to file it down
to something acceptable. I then measured and drilled the holes, trying
to make sure I could fit the 1602 screen snugly inside.</p>

<p>The end result:</p>

<center>
<div class="video-container">
    <iframe
        srcdoc="
            <style>
                body, .full {
                    height: 100%;
                    width: 100%;
                    margin: 0;
                    position: absolute;
                    display: flex;
                    justify-content: center;
                    object-fit: cover;
                }
            </style>
            <a href='https://www.youtube.com/embed/e7rA3GDg8qA?autoplay=1' class='full'>
                <img src='e7rA3GDg8qA.jpg' class='full'/>
                <svg version='1.1' viewBox='0 0 68 48' width='68px' style='position: relative;'>
                    <path d='M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z' fill='#f00'></path>
                    <path d='M 45,24 27,14 27,34' fill='#fff'></path>
                </svg>
            </a>"
        style="max-width: 40em; width: 100%; justify-content: center;"
        frameborder="0" allowfullscreen>
    </iframe>
</div>
</center>

<div style="text-align: center">
<em>PI(D) fan controller, I2C 1602 screen, power-off button</em>
</div>

<p>The I2C parts weren't without their own challenges. The screen was made
to work for 5V - I <em>(foolishly!)</em> tried it as-is, and it seemed to work...
But after <a href="https://electronics.stackexchange.com/questions/260611/how-to-use-a-logic-level-shifter-for-1602-lcd/314138#314138">looking around</a>.
I realized I was just lucky - my poor PI could have gone up in smoke...
(the scope showed that the GPIO pins were pulled up at 3.9V!)</p>

<p>I quickly bought a 1-Euro level shifter from eBay. <a href="android.html#serialport">I've used one before</a>,
when I "spoke" to my tablet's hidden serial port - so it was rather easy to
setup on my breadboard... and the SDA and SCL levels dropped down to the
proper 3.3V.</p>

<p>The rest was simple - I used a nice port of the <code>Wire</code> and <code>Liquid_Crystal</code>
Arduino libraries to control the screen; and <a href="https://github.com/ttsiodras/1602-LCD-Controller">output my disk usage, SoC 
temperature, CPU load and fan speed</a>.</p>

<p>Finally, I added a power-off button - which pulls up a GPIO pin, monitored
by another Supervisor-controlled Python daemon, that detects the press and
gracefully powers off the device.</p>

<div style="clear:both; text-align:center; margin: 0em 0em 0em 0em">
<img src="fritzing.png" alt="The Beast circuitry"><p>
<em>NOTE: No Orange PI Zero in Fritzing - this is just an</em><br>
<em>approximate drawing based on the older Orange PI PC</em>
</div>

<p>Besides being my "experimental platform", the Beast also doubles as my file/movie
server, and also my Borgbackup server. It <em>is</em> a UNIX server, after all.</p>

<h3>3. VHDL and FPGAs</h3>

<p>My other - and far more serious excursion into electronics, that I am nowhere
near mastering - is that of FPGAs and VHDL coding.</p>

<p>I started by watching the basics of VHDL in 3 videos by Nick Williams.
I then worked on a Spartan3 based FPGA, and used the free Xilinx WebPACK to
<a href="https://github.com/ttsiodras/UART_in_VHDL">write my own control circuit for a serial port</a> 
- that I myself exposed from the FPGA as a GPIO pin.</p>

<p>I communicated with my serial port via a PL2303HX adapter, attached to my
FPGA's GPIO pins on one side, and to my laptop over USB on the other:</p>

<div style="clear:both; text-align:center; margin: 0em 0em 0em 0em">
<a target="_blank" href="https://github.com/ttsiodras/UART_in_VHDL">
<img src="fpga.jpg" alt="A Spartan3, running my own VHDL serial code">
</a><p>
<em>A Spartan3, running my own VHDL serial code, speaks to a PL2303HX</em>
</div>

<p>Sending a serial signal was easy - but receiving, that was a different story...
The need to <a href="https://github.com/ttsiodras/UART_in_VHDL/blob/master/Example2.vhd#L643">sync up to the incoming signal</a>
made me deal for the first time with concurrently running VHDL state machines at different
clocks.</p>

<p>Lots of fun, debugging this :-) ... since there's no "debugging", really;
at least not in the way we do it in SW.
Mostly, you simulate your circuit and then look at the signals emitted
by it - and compare them to the expected ones in the protocols/datasheets.</p>

<p>And when even that fails, you order a 5 Euro logic analyzer from China... and desperately
probe everything. Which, miraculously, worked :-) Many thanks to the excellent
people behind <a href="https://sigrok.org/">Sigrok</a> - they made my cheap analyzer just
as efficient as 20 times more expensive products.</p>

<p>This - my FPGA programming attempts - deserves a blog post of its own <em>(for now,
I have <a href="https://github.com/ttsiodras/UART_in_VHDL/blob/master/README.md">documented the experience in my repo's README</a> )</em>.
This is truly a different world - and somehow, the fact that you express everything
as declarations of, basically, pin assignment expressions, meshes in a very
interesting way with <a href="score4.html">functional-style thinking</a> and declarative
programming.</p>

<p>And since there are open-source CPU designs... I may endeavor to synthesize my own
CPU core running inside that FPGA. Which sounds awesome :-)</p>

<p><strong>UPDATE</strong>: <a href="https://github.com/ttsiodras/grlib-gpl">Done!</a> I ported a Leon3 design
from Gaisler's GPL version of the GRLIB, inside my FPGA - and then compiled and
executed a program on a CPU that I "compiled" myself :-)</p>

<center>
<div class="video-container">
    <iframe
        srcdoc="
            <style>
                body, .full {
                    height: 100%;
                    width: 100%;
                    margin: 0;
                    position: absolute;
                    display: flex;
                    justify-content: center;
                    object-fit: cover;
                }
            </style>
            <a href='https://www.youtube.com/embed/Ylixb0AWAkQ?autoplay=1' class='full'>
                <img src='Ylixb0AWAkQ.jpg' class='full'/>
                <svg version='1.1' viewBox='0 0 68 48' width='68px' style='position: relative;'>
                    <path d='M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z' fill='#f00'></path>
                    <path d='M 45,24 27,14 27,34' fill='#fff'></path>
                </svg>
            </a>"
        style="max-width: 40em; width: 100%; justify-content: center;"
        frameborder="0" allowfullscreen>
    </iframe>
</div>
</center>

<div style="text-align: center">
<em>My own Leon3 CPU, running in my FPGA</em>
</div>

<p>&nbsp;</p>

<p><font color="red"><b>Discussion in</b></font> <a target="_blank" href="https://news.ycombinator.com/item?id=16460443">Hacker News</a>
<p>
<font color="red"><b>Discussion in</b></font> <a target="_blank" href="https://hackaday.com/2017/08/08/atmega328-3d/">Hackaday</a></p>

<br>
    <hr>
    <div style='margin-top:1em'>
        <div style='float:left'>
            <a target="_blank" href="https://stackoverflow.com/users/382050/ttsiodras">
                <img src="382050.png" width="208" height="58" alt="profile for ttsiodras at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for ttsiodras at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
            </a>
        </div>
        <div style='float:left; margin-left:1em'>
            <a target="_blank" href="https://github.com/ttsiodras">
                <img border="1" src="github.png" alt='GitHub member ttsiodras' title='GitHub member ttsiodras'>
            </a>
        </div>
        <!--div style='float:left; margin-left:1em'>
            <a target="_blank" href="https://projecteuler.net/profile/ttsiodras.png">
                <img src="https://projecteuler.net/profile/ttsiodras.png" alt='Project Euler member ttsiodras' title='Project Euler member ttsiodras'>
            </a>
        </div-->
    </div>
    <div style='clear:both; margin-bottom:0.5em'></div>

<!-- Used to do this with float:right, but Opera Mini shows nothing with it... back to tables :-( -->
<table summary="Footer" width="100%" border="0"><tr><td><a href="index.html">Index</a>&nbsp;&nbsp;<a href="cv.pdf">CV</a></td><td align="right"><em>Updated: Sat Oct 8 11:41:25 2022</em></td></tr></table>

            <hr style="margin-bottom: 1em">
            <p id="disqus_thread">
                The comments on this website require the use of JavaScript. Perhaps your browser isn't
                JavaScript capable or the script is not being run for another reason. If you're
                interested in reading the comments or leaving a comment behind please try again with a
                different browser or from a different connection.
            </p>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'ttsiodras';
                var disqus_identifier = '../content/thebeast.content';

                (function() {
                    'use strict';

                    /**
                     * This method will handle the click on the button to load the comments. It will remove the
                     * button and execute the original Disqus script for loading the comments.
                     */
                    function button_clickHandler(event) {
                        // We need to get the button element, we could also use the target property of the event
                        // but this will do just as well
                        var button = document.getElementById('disqus_thread');
                        // Now we will have to recreate the div element we removed from the HTML. We will place
                        // it into the DOM like we did when we created the button
                        var disqusContainer = document.createElement('div');
                        button.parentNode.insertBefore(disqusContainer, button);
                        button.parentNode.removeChild(button);

                        // The div element will need to have the disqus_thread id as this is required for Disqus,
                        // it is the way their code identifies the element in which the comments can be displayed
                        disqusContainer.id = 'disqus_thread';

                        // Now we can execute the original Disqus code
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    }

                    /**
                     * This method will initialize the module. It will replace the JavaScript dependency message
                     * with a button which will allow the visitor to load the comments.
                     */
                    function init() {
                        // Try to get the element we used to display the message about the JavaScript dependency
                        var placeholder = document.getElementById('disqus_thread');
                        // If we didn't get the placeholder element we will stop setting up the button to load
                        // the comments
                        if (placeholder == null) {
                            return;
                        }

                        // The placeholder was found, now we can create the button which will allow the visitor to
                        // load the comments
                        var button = document.createElement('button');
                        button.appendChild(document.createTextNode('Click here to see the comments (powered by Disqus)'));
                        button.addEventListener('click', button_clickHandler.bind(this));

                        // We will insert the button before the placeholder and once the button has been placed in
                        // the DOM we will remove the placeholder
                        placeholder.parentNode.insertBefore(button, placeholder);
                        placeholder.parentNode.removeChild(placeholder);

                        // The placeholder used to have the id which can be reference by an anchor element, to make
                        // sure we don't break this functionality we will apply the id to our newly created button
                        button.id = 'disqus_thread';
                    }

                    // Setup the module
                    init();
                })();
            </script>
        </div>
    </div>
</body>
</html>
